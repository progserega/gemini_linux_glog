# ะะฐัััะพะนะบะฐ barman ะดะปั ัะตะทะตัะฒะธัะพะฒะฐะฝะธั postgres
## ะะพะณะธะบะฐ ัะฐะฑะพัั barman

=>../img/barman-architecture-scenario1b.png ะััะธัะตะบัััะฐ barman

# ะะพัััะฐะฝะพะฒะปะตะฝะธะต

### ะะฐะถะฝะฐั ัะตะผะฐัะบะฐ
ะะพัะปะต ัะฑะพั postgres-ะฐ ะธะปะธ ะถะตะปะฐั ะฟะพะพัะบะฐััะฒะฐัั ะฑัะบะฐะฟั - ะฝัะถะฝะพ ัะฝะฐัะฐะปะฐ ะพััะฐะฝะพะฒะธัั ะฟะตัะตะดะฐัั wal-ัะฐะนะปะพะฒ ั ัะตัะฒะตัะฐ postgres ะฒ ัะตัะฒะธั barman-ะฐ, ััะพะฑั ะพะฝ ะฝะต ะฝะฐะบะฐััะฒะฐะป wal-ะฐ ะฟะพะฒะตัั ัะฒะพะตะณะพ ะฑัะบะฐะฟะฐ ะฟะพัะปะต ะพัะบะฐัะฐ. ะะฝะฐัะต ะฒัั ะผะพะถะตั ัะผะตัะฐัััั ะฒ ะบััั ะธ ะดะฐะฝะฝัะต ะฑัะดัั ะฟะพัะตััะฝั.
ะข.ะต. ะผะพะถะตั ะฑััั ัะธััะฐัะธั:
* ะฝะฐ barman ะตััั ะฑัะบะฐะฟั ั ะฒัะตะผะตะฝะธ 1 ะฟะพ ะฒัะตะผั 10
* ะผั ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฑัะบะฐะฟ ะฝะฐ ะฒัะตะผั 5 
* ัะผะพััะธะผ ะฒ ะฑะฐะทะต - ะพะฝะพ ะปะธ - ะฒัั ะปะธ ะตััั
* ะฟะพะบะฐ ัะผะพััะธะผ - postgres ะฝะฐัะธะฝะฐะตั ะปะธัั wal-ะฐ ะฝะฐ barman ะธ ะผั ะฑะพะปะตะต ะฝะต ัะผะพะถะตะผ ะพัะบะฐัะธัั ะฑัะบะฐะฟ ะฝะฐ ะฒัะตะผั 6, 7 ะธ ะฒััะต. ะัะพะดะต ะบะฐะบ ัะฐะบะพะณะพ ะฝะต ะดะพะปะถะฝะพ ะฑััั, ะฝะพ ะฟะฐัั ัะฐะท ะฝะฐ ัะตััะฐั ั ะผะตะฝั ะฑัะฒะฐะปะพ, ััะพ ั ัะตััะป ะฒะพะทะผะพะถะฝะพััั ะฟะพะฒัะพัะฝะพ ะฒะพัััะฐะฝะพะฒะธัััั ะฝะฐ ะฑะพะปะตะต ัะฒะตะถะธะน ััะตะท ะฒัะตะผะตะฝะธ.

ะงัะพะฑั ะธัะบะปััะธัั ะฟะพะดะพะฑะฝัั ัะธััะฐัะธั - ะฝัะถะฝะพ ะฟะตัะตะด ะฒะพัััะฐะฝะพะฒะปะตะฝะธะตะผ ะฑัะบะฐะฟะฐ ะธะท barman-ะฐ ะพัะบะปััะธัั ะฟะตัะตะดะฐัั wal-ัะฐะนะปะพะฒ ั postgres ะฝะฐ barman. ะะปั ััะพะณะพ ะฒ ะบะพะฝัะธะณะต postgres ะบะพะผะผะตะฝัะธััะตะผ ัััะพะบั:
```
archive_command = 'barman-wal-archive pg-cluster02.rs.int pg_cluster01 %p'
```
ััะพ ะพัะบะปััะธั ะฟะตัะตะดะฐัั wal-ัะฐะนะปะพะฒ ะฝะฐ barman. ะะพัะปะต ัะตะณะพ ะผะพะถะฝะพ ะฟัะพะฑะพะฒะฐัั ะพัะบะฐััะฒะฐัั ัะฐะทะฝัะต ะฒะตััะธะธ ะฑัะบะฐะฟะฐ ะฝะฐ postgres, ัะผะพััะตัั ะธ ะฝะต ะฒะพะปะฝะพะฒะฐัััั. ะะพัะปะต ัะตัะตะฝะธั, ััะพ ะฑัะบะฐะฟ ะฝะฐั ััััะฐะธะฒะฐะตั - ะฝัะถะฝะพ ะฑัะดะตั ะทะฐะฝะพะฒะพ ัะฐัะบะพะผะผะตะฝัะธัะพะฒะฐัั ััั ัััะพะบั.

### ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพััั ะดะตะนััะฒะธะน ะฟัะธ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะธ ัะฐะบะพะฒะฐ:
1. ะัะพะธะทะพััะป ัะฑะพะน PostgreSQL ัะตัะฒะตัะฐ ะธะปะธ ะผั ัะตัะธะปะธ ะพัะบะฐัะธัั ะดะฐะฝะฝัะต.
2. ะะฐ ัะตัะฒะตัะต postgres (ะตัะปะธ ะฑัะป ัะฑะพะน - ะทะฐะฝะพะฒะพ ัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัะตัะฒะตั postgres, ะฟะพะดะบะปััะฐะตะผ ะตะณะพ ะบ barman) ะพัะบะปััะฐะตะผ ะฟะตัะตะดะฐัั wall-ัะฐะนะปะพะฒ, ะบะฐะบ ะพะฟะธัะฐะฝะพ ะฒ ัะตะผะฐัะบะต ะฒััะต.
3. ะพััะฐะฝะฐะฒะปะธะฒะฐะตะผ PostgreSQL ะฝะฐ ัะตัะฒะตัะต ะฑะฐะทั ะดะฐะฝะฝัั:
```
systemctl stop postgresql.service
```
4. ะะตะปะฐัะตะปัะฝะพ ัะพััะฐะฝะธัั ะดะธัะตะบัะพัะธั ั ัะฐะนะปะฐะผะธ ะฑะฐะทั ะดะฐะฝะฝัั: 
```
mv /var/lib/postgresql/13/main /var/lib/postgresql/13/main.old.bak
```
5. ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะดะฐะฝะฝัะต postgresql-ัะตัะฒะตัะฐ ั ัะตัะฒะตัะฐ barman (ะบะพะผะฐะฝะดั ะทะฐะฟััะบะฐะตะผ ะฝะฐ ัะตัะตัะต barman):
ะะธะฑะพ ัะฐะผัะต ะฟะพัะปะตะดะฝะธะต ะดะพัััะฟะฝัะต ะดะฐะฝะฝัะต:
```
barman recover --get-wal --remote-ssh-command 'ssh postgres@pg-cluster01.rs.int' pg_cluster01 latest /var/lib/postgresql/13/main
```
ะะธะฑะพ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต ะฝะฐ ะบะพะฝะบัะตัะฝัั ะดะฐัั ะฝะฐ ัะตัะฒะตัะต barman ะธะท-ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปั barman:
```
barman recover --get-wal --remote-ssh-command 'ssh postgres@pg-cluster01.rs.int'  --target-time "2023-03-14 11:18:00+10:00" pg_cluster01 20230314T111258 /var/lib/postgresql/13/main
```
ะะดะต 20230314T111258 - ะธะผั ะฑัะบะฐะฟะฐ, ะบะพัะพัะพะต ะฒัะดะฐัั ะบะพะผะฐะฝะดะฐ `barman list-backup pg_cluster01`, ะปะธะฑะพ ััะพ ะธะผั ะผะพะถะตั ะฟัะธะฝะธะผะฐัั ะทะฝะฐัะตะฝะธะต latest - ัะฐะผัะน ะฟะพัะปะตะดะฝะธะน ะฑัะบะฐะฟ.
6. ะะฐ ัะตัะตัะต postgres ะทะฐะฟััะบะฐะตะผ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต (ะธะท-ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปั postgres):
```
 /usr/lib/postgresql/13/bin/postgres --single -c config_file=/etc/postgresql/13/main/postgresql.conf -D /var/lib/postgresql/13/main -P -d 5
```
7. ะฟะพัะปะต ัะตะณะพ ะฝะฐะถะธะผะฐะตะผ ctrl+d, ะฒััะพะดะธ, ะฒััะพะดะธั ะธะท-ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปั postgres ะธ ัะถะต ะธะท-ะฟะพะด ัััะฐ ะทะฐะฟััะบะฐะตะผ postgres ะบะฐะบ ัะตัะฒะธั:
```
systemctl start postgresql.service
```
ะขัั ะถะต ะทะฐะนะดั ะฒ ะฟะพััะณัะตั ะบะปะธะตะฝัะพะผ ะธ ัะดะตะปะฐะฒ select ะฒ ะฝัะถะฝะพะน ัะฐะฑะปะธัะต - ะผะพะถะฝะพ ัะฒะธะดะตัั ะบะฐะบ ะฟะพัะฒะปััััั (ะฟะพััะตะฟะตะฝะฝะพ) ะทะฐะฟะธัะธ ะดะพ ัะบะฐะทะฐะฝะฝะพะณะพ ะฒัะตะผะตะฝะธ.

ะะฐะฒะตััะฐะตะผ ะฟัะพัะตัั ะฒะพัััะฐะฝะพะฒะปะตะฝะธั ะฝะฐ Postgres-ะต (ะฒัะต ะดะฐะฝะฝัะต ัะฐะผ ะฒ ัะตะถะธะผะต "ัะพะปัะบะพ ััะตะฝะธะต" ะดะพ ััะพะณะพ ะผะพะผะตะฝัะฐ):
```
postgres=# select pg_wal_replay_resume();
 pg_wal_replay_resume 
----------------------
 
(1 row)
```
ะะพัะปะต ััะพะณะพ ะผะพะถะฝะพ ะฟะธัะฐัั ะฒ ัะฐะฑะปะธัั.
### ะะฐะฝะพะฒะพ ะทะฐะฟััะบะฐะตะผ ะฑัะบะฐะฟ postgres->barman
ะะพัะปะต ะฒะพัััะฐะฝะพะฒะปะตะฝะธั ะฝะฐ ะฑะพะปะตะต ัะฐะฝะฝัั ะดะฐัั - ะฝัะถะฝะพ ะทะฐะฟัััะธัั ัะตะฟะปะธะบะฐัะธั ะบะพะผะฐะฝะดะพะน ะฝะฐ barman-ะต:
```
barman receive-wal --reset pg_cluster01
```
ะัะปะธ ะฒ ะพัะฒะตั ะฟะพะปััะฐะตะผ ะพัะธะฑะบั ะฒะธะดะฐ:
```
barman@pg-cluster02:/root$ barman receive-wal --reset pg_cluster01
ERROR: The receive-wal position is ahead of PostgreSQL current WAL lsn (000000070000000000000029.partial > None)
```
ะขะพ ะฝัะถะฝะพ ัะฑัะฐัั ัะฐะนะปั ะธะท streaming ะธ ะฟะพะฒัะพัะธัั ะฟัะพัะตัั:
```
mkdir /mnt/backup/barman/pg_cluster01/streaming.old/
mv /mnt/backup/barman/pg_cluster01/streaming/* /mnt/backup/barman/pg_cluster01/streaming.old/
barman receive-wal --reset pg_cluster01
```
ะะพะดะพะถะดะฐัั ะฟะฐัั ะผะธะฝัั, ะฟะพะบะฐ ะฝะต ะทะฐะฟัััะธัััั ะฒ barman ะตัั ะพะดะฝะฐ ะพะฟะฟััะบะฐ ัะตะฟะปะธะบะฐัะธะธ. ะ ะทะฐะฟัััะธัั ะฟัะพะฒะตัะบั ััะฐัััะฐ ัะปะพัะฐ:
```
barman check pg_cluster01
```
ะ ัะฐะผ ะดะพะปะถะฝะพ ะฑััั ะฒัั ัะพัะพัะพ.

ะขะฐะบ ะถะต ะผะพะถะตั ะฑััั ะฟะพะฝะฐะดะพะฑะธััั ะบะพะผะฐะฝะดะฐ ะฟะตัะตัะฑะพัะบะธ ะฑะฐะทั barman ะธ, ะผะพะถะตั ะฑััั, ะฟะพะฒัะพัะฝัะน ัะฑัะพั ะธะฝะดะตะบัะพะฒ wal:
```
barman rebuild-xlogdb pg_cluster01
barman receive-wal --reset pg_cluster01
```

=>../index.gmi ๐ ะฒะตัะฝััััั ะบ ะฝะฐัะฐะปั...
