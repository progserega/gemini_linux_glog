# ะะฐัััะพะนะบะฐ barman ะดะปั ัะตะทะตัะฒะธัะพะฒะฐะฝะธั postgres
## ะะพะณะธะบะฐ ัะฐะฑะพัั barman

=>../img/barman-architecture-scenario1b.png ะััะธัะตะบัััะฐ barman
ะะฐะฟััะบ ะฒะพัััะฐะฝะพะฒะปะตะฝะธั ะฟะพัะปะตะดะฝะตะณะพ ัะฒะตะถะตะณะพ ะฑัะบะฐะฟะฐ (ั ะฟะพัะปะตะดะฝะธะผะธ wal-ะฐะผะธ) - ั.ะต. ัะฐะผัะน ัะฒะตะถะธะน ะฒะฐัะธะฐะฝั ะดะฐะฝะฝัั:
```

# ะะพัััะฐะฝะพะฒะปะตะฝะธะต

ะะพัะปะต ัะฑะพั postgres-ะฐ ะธะปะธ ะถะตะปะฐั ะฟะพะพัะบะฐััะฒะฐัั ะฑัะบะฐะฟั - ะฝัะถะฝะพ ัะฝะฐัะฐะปะฐ ะพััะฐะฝะพะฒะธัั ัะตัะฒะธั barman-ะฐ, ััะพะฑั ะพะฝ ะฝะต ะฝะฐะบะฐััะฒะฐะป wal-ะฐ ะฟะพะฒะตัั ัะฒะพะตะณะพ ะฑัะบะฐะฟะฐ ะฟะพัะปะต ะพัะบะฐัะฐ. ะะฝะฐัะต ะฒัั ะผะพะถะตั ัะผะตัะฐัััั ะฒ ะบััั ะธ ะดะฐะฝะฝัะต ะฑัะดัั ะฟะพัะตััะฝั.

ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพััั ะดะตะนััะฒะธะน ัะฐะบะพะฒะฐ:
1. ะัะพะธะทะพััะป ัะฑะพะน PostgreSQL ัะตัะฒะตัะฐ ะธะปะธ ะผั ัะตัะธะปะธ ะพัะบะฐัะธัั ะดะฐะฝะฝัะต.
1. ะะฐ ัะตัะฒะตัะต barman ะบะพะผะผะตะฝัะธััะตะผ ะทะฐะดะฐะฝะธะต ะฒ ัะฐะนะปะต 
```
/etc/cron.d/barman
```
1. ะฝะฐ ะฒััะบะธะน ัะปััะฐะน ะพััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟะตัะตะดะฐัั wal-ัะฐะนะปะพะฒ ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปะตะผ barman 
```
barman receive-wal --stop pg_cluster01
```
1. ะพััะฐะฝะฐะฒะปะธะฒะฐะตะผ PostgreSQL ะฝะฐ ัะตัะฒะตัะต ะฑะฐะทั ะดะฐะฝะฝัั: `
```
systemctl stop postgresql.service
```
1. ะะตะปะฐัะตะปัะฝะพ ัะพััะฐะฝะธัั ะดะธัะตะบัะพัะธั ั ัะฐะนะปะฐะผะธ ะฑะฐะทั ะดะฐะฝะฝัั: 
```
mv /var/lib/postgresql/13/main /var/lib/postgresql/13/main.old.bak
```
1. ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะดะฐะฝะฝัะต postgresql-ัะตัะฒะตัะฐ ั ัะตัะฒะตัะฐ barman (ะบะพะผะฐะฝะดั ะทะฐะฟััะบะฐะตะผ ะฝะฐ ัะตัะตัะต barman):
ะะธะฑะพ ัะฐะผัะต ะฟะพัะปะตะดะฝะธะต ะดะพัััะฟะฝัะต ะดะฐะฝะฝัะต:
```
barman recover --get-wal --remote-ssh-command 'ssh postgres@pg-cluster01.rs.int' pg_cluster01 latest /var/lib/postgresql/13/main
```
ะะธะฑะพ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต ะฝะฐ ะบะพะฝะบัะตัะฝัั ะดะฐัั ะฝะฐ ัะตัะฒะตัะต barman ะธะท-ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปั barman:
```
barman recover --get-wal --remote-ssh-command 'ssh postgres@pg-cluster01.rs.int'  --target-time "2023-03-14 11:18:00+10:00" pg_cluster01 20230314T111258 /var/lib/postgresql/13/main.recover
```
ะะดะต 20230314T111258 - ะธะผั ะฑัะบะฐะฟะฐ, ะบะพัะพัะพะต ะฒัะดะฐัั ะบะพะผะฐะฝะดะฐ `barman list-backup pg_cluster01`, ะปะธะฑะพ ััะพ ะธะผั ะผะพะถะตั ะฟัะธะฝะธะผะฐัั ะทะฝะฐัะตะฝะธะต latest - ัะฐะผัะน ะฟะพัะปะตะดะฝะธะน ะฑัะบะฐะฟ.
1. ะะฐ ัะตัะตัะต postgres ะปะธะฑะพ ะฟัะพััะพ ััะฐัััะตะผ postgres:
```
systemctl start postgresql.service
```
ะะธะฑะพ ะทะฐะฟััะบะฐะตะผ ะฒะพัััะฐะฝะพะฒะปะตะฝะธั postgres ะฝะฐ ัะตัะฒะตัะต postgres (ะธะท-ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปั postgres):
```
 /usr/lib/postgresql/13/bin/postgres --single -c config_file=/etc/postgresql/13/main/postgresql.conf -D /var/lib/postgresql/13/main -P -d 5
```
ะฟะพัะปะต ัะตะณะพ ะฝะฐะถะธะผะฐะตะผ ctrl+d, ะฒััะพะดะธ, ะฒััะพะดะธั ะธะท-ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปั postgres ะธ ัะถะต ะธะท-ะฟะพะด ัััะฐ ะทะฐะฟััะบะฐะตะผ postgres ะบะฐะบ ัะตัะฒะธั:
```
systemctl start postgresql.service
```

=>../index.gmi ๐ ะฒะตัะฝััััั ะบ ะฝะฐัะฐะปั...
