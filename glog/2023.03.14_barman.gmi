# ะะฐัััะพะนะบะฐ barman ะดะปั ัะตะทะตัะฒะธัะพะฒะฐะฝะธั postgres
## ะะพะณะธะบะฐ ัะฐะฑะพัั barman

=>../img/barman-architecture-scenario1b.png ะััะธัะตะบัััะฐ barman
* ะะฐ postgres ะตััั ะถััะฝะฐะป (wal-ั). ะะตัะตะด ะทะฐะฟะธััั ะดะฐะฝะฝัั postgres ะฟะธัะตั ััะฐะฝะทะฐะบัะธั ะฒ ะถััะฝะฐะป ะฝะฐ ะดะธัะบ ะธ ัะพะปัะบะพ ะฟะพัะพะผ ะผะตะฝัะตั ะดะฐะฝะฝัะต. ะญัะพ ะฟะพะทะฒะพะปัะตั ะฒ ัะปััะฐะต ัะฑะพั postgres-ั ะพัะบะฐัะธัั ะฝะตะทะฐะบะพะฝัะตะฝะฝัะต ััะฐะฝะทะฐะบัะธะธ.
* Postgres ัะผะตะตั ะฒ ัะตะถะธะผะต ัะตะฟะปะธะบะฐัะธะธ ะฟะตัะตะดะฐะฒะฐัั ััะธ ัะฐะนะปั-ััะฐะฝะทะฐะบัะธะน-ะถััะฝะฐะปะฐ (wal-ั) ะดััะณะธะผ ัะตัะฒะตัะฐะผ postgres ะธะดะธ ัะธััะตะผะต ะฑัะบะฐะฟะฐ barman. ะคะฐะนะปั ััะธ ะฟะพ-ัะผะพะปัะฐะฝะธั ัะฐะทะผะตัะพะผ 16 ะผะฑ. ะะฐะบ ัะพะปัะบะพ ะฝะฐะบะฐะฟะปะธะฒะฐะตััั ะพะดะธะฝ ัะฐะนะป - ัะพะทะดะฐัััั ะฝะพะฒัะน ะธ ั.ะฟ. ะะพ ะทะฐะฟะพะปะฝะตะฝะธั - ัะฐะนะป ะฟะตัะตะดะฐัััั ะฟะพ ัะตะฟะปะธะบะฐัะธะธ.
* ััะพะฑั ะฝะต ะถะดะฐัั ะฟะพะบะฐ ะทะฐะฟะพะปะฝะธััั ัะฐะนะป, ะฐ ะฟะตัะตะดะตะฒะฐัั ััะฐะฝะทะฐะบัะธะธ ะปัะฑะพะณะพ ัะฐะทะผะตัะฐ ัะฐะท ะฒ ะผะธะฝััั - ะฝัะถะฝะพ ะฒ ะบะพะฝัะธะณะต postgres ะฒัััะฐะฒะธัั ะพะฟัะธั archive_timeout=60 - ะธ ัะพะณะดะฐ wal-ั ะฑัะดัั ะฟะตัะตะดะฐะฒะฐัััั ะบะฐะถะดัะต 60 ัะตะบัะฝะด, ะดะฐะถะต ะตัะปะธ ะพะฝะธ ะฝะต ะดะพััะธะณะปะธ 16 ะผะฑ (ะฒ barmanะต ะพะฝะธ ะฑัะดัั ะบะฐะบ "partial")
* ะะฐะบ ัะพะปัะบะพ ะฟะพัะฒะธะปะธัั ะฝะพะฒัะต ะดะฐะฝะฝัะต ะฒ wal-ะฐั - postgres ะทะฐะฟััะบะฐะตั ะบะพะผะฐะฝะดั ะธะท ัะฒะพะตะน ะบะพะฝัะธะณััะฐัะธะธ: archive_command = 'barman-wal-archive pg-cluster02.rs.int pg_cluster01 %p'. ะญัะฐ ะบะพะผะฐะฝะดะฐ (barman-wal-archive) ะฟะพ ssh (ะดะพะปะถะฝั ะฑััั ะฝะฐัััะพะตะฝะฝั ัะพะตะดะธะฝะตะฝะธั ัะตัะตะท ะฟัะฑะปะธัะฝัะน ะบะปัั ะฑะตะท ะฟะฐัะพะปั ะผะตะถะดั postgres@postgres-server ะธ barman@barman-server - ััะดะฐ ะธ ะพะฑัะฐัะฝะพ!) ะฟะพะดะบะปััะฐะตััั ะฝะฐ barman-ัะตัะฒะตั ะธ ะฟะตัะตะดะฐัั wal-ัะฐะนะปั ะฝะฐ ัะตัะฒะตั barman.
* barman ัะตัะตะท ะฟะพะดัะธััะตะผั ัะตะฟะปะธะบะฐัะธะธ postgres ะฒ ัะปััะฐะต ะทะฐะฟัะพัะฐ ะฟะพะปัะทะพะฒะฐัะตะปั - ะดะตะปะฐะตั ะฟะพะปะฝัะต ะฑัะบะฐะฟั ัะตัะฒะตัะฐ postgres
* barman ัะตัะตะท ะฟะพะดัะธััะตะผั ัะตะฟะปะธะบะฐัะธะธ postgres ะฟะพ cron-ะทะฐะดะฐะฝะธั ะดะตะปะฐ - ะดะตะปะฐะตั ัะตะณัะปััะฝัะต ะฟะพะปะฝัะต ะฑัะบะฐะฟั ัะตัะฒะตัะฐ postgres ะธ ะฟะพะดัะธัะฐะตั ัััะฐัะตะฒัะธะต ะฑัะบะฐะฟั ะฒ ัะพะพัะฒะตัััะฒะธะธ ั ะฟะพะปะธัะธะบะพะน ััะฐะฝะตะฝะธั, ะทะฐะดะฐะฝะฝะพะน ะดะปั ะบะฐะถะดะพะณะพ "ัะปะพัะฐ"
* ัะพะพัะฒะตัััะฒะตัััะฒะตะฝะฝะพ ะฒ ะดะธัะตะบัะพัะธะธ ััะฐะฝะตะฝะธั ั barman ะฝะฐะบะฐะฟะปะธะฒะฐัััั wal-ัะฐะนะปั ััะฐะฝะทะฐะบัะธะน.
* ะฒ ัะปััะฐะต ะทะฐะฟัะพัะฐ barman ะผะพะถะตั ะธะท ะดะฐะฝะฝัั ะฟะพะปะฝะพะณะพ ะฑัะบะฐะฟะฐ ะธ wal-ัะฐะนะปะพะฒ ััะพัะผะธัะพะฒะฐัั ะฟะพะปะฝัั ะดะธัะตะบัะพัะธั ะดะฐะฝะฝัั ะฝะฐ ัะตัะฒะตัะต postgres (ะบะพะผะฐะฝะดะฐ "barman recover ...")
* ะฟะพัะปะต ัะตะณะพ ะผั ะทะฐะฟััะบะฐะตะผ postgres ะธ ะพะฝ ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตั ะดะฐะฝะฝัะต ะฒ ัะฒะพะตะน ะดะธัะตะบัะพัะธะธ ั ััััะพะผ ะฝะฐะปะธัะตััะฒัััะธั wal-ัะฐะนะปะพะฒ. ะะฟัะธะพะฝะฐะปัะฝะพ - postgres ะผะพะถะตั ะทะฐะฟัะพัะธัั ะธ ัะบะฐัะฐัั ะฝะตะดะพััะฐััะธะต ัะฐััะธัะฝัะต (partial) wal-ัะฐะนะปั ั ัะตัะฒะตัะฐ barman (ะฒ ะฟัะพัะตััะต ะฒะพัััะฐะฝะพะฒะปะตะฝะธั ะดะฐะฝะฝัั postgres).

# ะะฝะฐะปะธะท ัะฐะฑะพัั

## ะกะฒะตัะบะฐ ััะฐัััะฐ ัะธะฝััะพะฝะธะทะฐัะธะธ
```
barman replication-status pg_1c_prim_drsk_ru
```
ะฒัะฒะพะด:
```
Status of streaming clients for server 'pg_1c_prim_drsk_ru':
Current LSN on master: 62/5000000
Number of streaming clients: 1

1. Async WAL streamer
Application name: barman_receive_wal
Sync stage      : 2/3 WAL Sent (min)
Communication   : TCP/IP
IP Address      : 10.75.232.213 / Port: 54636 / Host: -
User name       : streaming_barman
Current state   : streaming (async)
Replication slot: pg_1c_prim_drsk_ru
WAL sender PID  : 24668
Started at      : 2025-04-18 09:39:02.200279+10:00
Sent LSN   : 62/5000000 (diff: 0 B)
Write LSN  : 62/4000140 (diff: -16.0 MiB)
Flush LSN  : 62/4000000 (diff: -16.0 MiB)
```
ะณะดะต:
Sent LSN - ะพัะฟัะฐะฒะปะตะฝะฝัะน ะฒ ัะตะฟะปะธะบะฐัะธั ะธะดะตะฝัะธัะธะบะฐัะพั wal-ะฐ
Write LSN - ะทะฐะฟะธัะฐะฝะฝัะน ะฝะฐ ะบะปะธะตะฝัะต (ะฑะฐัะผะฐะฝะต)
Flush LSN - ัะบะธะฝัััะน ะฝะฐ ะดะธัะบ ะฝะฐ ะบะปะธะตะฝัะต (ะธะท ะบััะฐ ะฒ ะะะฃ)

# ะะพัััะฐะฝะพะฒะปะตะฝะธะต

### ะะฐะถะฝะฐั ัะตะผะฐัะบะฐ
ะะพัะปะต ัะฑะพั postgres-ะฐ ะธะปะธ ะถะตะปะฐั ะฟะพะพัะบะฐััะฒะฐัั ะฑัะบะฐะฟั - ะฝัะถะฝะพ ัะฝะฐัะฐะปะฐ ะพััะฐะฝะพะฒะธัั ะฟะตัะตะดะฐัั wal-ัะฐะนะปะพะฒ ั ัะตัะฒะตัะฐ postgres ะฒ ัะตัะฒะธั barman-ะฐ, ััะพะฑั ะพะฝ ะฝะต ะฝะฐะบะฐััะฒะฐะป wal-ะฐ ะฟะพะฒะตัั ัะฒะพะตะณะพ ะฑัะบะฐะฟะฐ ะฟะพัะปะต ะพัะบะฐัะฐ. ะะฝะฐัะต ะฒัั ะผะพะถะตั ัะผะตัะฐัััั ะฒ ะบััั ะธ ะดะฐะฝะฝัะต ะฑัะดัั ะฟะพัะตััะฝั.
ะข.ะต. ะผะพะถะตั ะฑััั ัะธััะฐัะธั:
* ะฝะฐ barman ะตััั ะฑัะบะฐะฟั ั ะฒัะตะผะตะฝะธ 1 ะฟะพ ะฒัะตะผั 10
* ะผั ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฑัะบะฐะฟ ะฝะฐ ะฒัะตะผั 5 
* ัะผะพััะธะผ ะฒ ะฑะฐะทะต - ะพะฝะพ ะปะธ - ะฒัั ะปะธ ะตััั
* ะฟะพะบะฐ ัะผะพััะธะผ - postgres ะฝะฐัะธะฝะฐะตั ะปะธัั wal-ะฐ ะฝะฐ barman ะธ ะผั ะฑะพะปะตะต ะฝะต ัะผะพะถะตะผ ะพัะบะฐัะธัั ะฑัะบะฐะฟ ะฝะฐ ะฒัะตะผั 6, 7 ะธ ะฒััะต. ะัะพะดะต ะบะฐะบ ัะฐะบะพะณะพ ะฝะต ะดะพะปะถะฝะพ ะฑััั, ะฝะพ ะฟะฐัั ัะฐะท ะฝะฐ ัะตััะฐั ั ะผะตะฝั ะฑัะฒะฐะปะพ, ััะพ ั ัะตััะป ะฒะพะทะผะพะถะฝะพััั ะฟะพะฒัะพัะฝะพ ะฒะพัััะฐะฝะพะฒะธัััั ะฝะฐ ะฑะพะปะตะต ัะฒะตะถะธะน ััะตะท ะฒัะตะผะตะฝะธ.

ะงัะพะฑั ะธัะบะปััะธัั ะฟะพะดะพะฑะฝัั ัะธััะฐัะธั - ะฝัะถะฝะพ ะฟะตัะตะด ะฒะพัััะฐะฝะพะฒะปะตะฝะธะตะผ ะฑัะบะฐะฟะฐ ะธะท barman-ะฐ ะพัะบะปััะธัั ะฟะตัะตะดะฐัั wal-ัะฐะนะปะพะฒ ั postgres ะฝะฐ barman. ะะปั ััะพะณะพ ะฒ ะบะพะฝัะธะณะต postgres ะบะพะผะผะตะฝัะธััะตะผ ัััะพะบั:
```
archive_command = 'barman-wal-archive pg-cluster02.rs.int pg_cluster01 %p'
```
ััะพ ะพัะบะปััะธั ะฟะตัะตะดะฐัั wal-ัะฐะนะปะพะฒ ะฝะฐ barman. ะะพัะปะต ัะตะณะพ ะผะพะถะฝะพ ะฟัะพะฑะพะฒะฐัั ะพัะบะฐััะฒะฐัั ัะฐะทะฝัะต ะฒะตััะธะธ ะฑัะบะฐะฟะฐ ะฝะฐ postgres, ัะผะพััะตัั ะธ ะฝะต ะฒะพะปะฝะพะฒะฐัััั. ะะพัะปะต ัะตัะตะฝะธั, ััะพ ะฑัะบะฐะฟ ะฝะฐั ััััะฐะธะฒะฐะตั - ะฝัะถะฝะพ ะฑัะดะตั ะทะฐะฝะพะฒะพ ัะฐัะบะพะผะผะตะฝัะธัะพะฒะฐัั ััั ัััะพะบั.

### ะะพัะปะตะดะพะฒะฐัะตะปัะฝะพััั ะดะตะนััะฒะธะน ะฟัะธ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะธ ัะฐะบะพะฒะฐ:
1. ะัะพะธะทะพััะป ัะฑะพะน PostgreSQL ัะตัะฒะตัะฐ ะธะปะธ ะผั ัะตัะธะปะธ ะพัะบะฐัะธัั ะดะฐะฝะฝัะต.
2. ะะฐ ัะตัะฒะตัะต postgres (ะตัะปะธ ะฑัะป ัะฑะพะน - ะทะฐะฝะพะฒะพ ัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัะตัะฒะตั postgres, ะฟะพะดะบะปััะฐะตะผ ะตะณะพ ะบ barman) ะพัะบะปััะฐะตะผ ะฟะตัะตะดะฐัั wall-ัะฐะนะปะพะฒ, ะบะฐะบ ะพะฟะธัะฐะฝะพ ะฒ ัะตะผะฐัะบะต ะฒััะต.
3. ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ postgres
4. ะถะตะปะฐัะตะปัะฝะพ ะบะพะฟะธััะตะผ ะบัะดะฐ-ะฝะธะฑัะดั ะดะธัะตะบัะพัะธั ั ะดะฐะฝะฝัะผะธ postgres-ะฐ (ะตัะปะธ ัะฐะผ ััะพ-ัะพ ะพััะฐะปะพัั)
5. ะะฐะฟััะบะฐะตะผ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต ะฝะฐ ัะตัะฒะตัะต barman
6. ะกัะฐัััะตะผ postgres
7. ะ ัะปััะฐะต ะฝะตะพะฑัะพะดะธะผะพััะธ ะฟัะพะฒะพะดะธะผ ะดะพะฟะพะปะฝะธัะตะปัะฝัะต ะดะตะนััะฒะธั ะฟะพ ะฟะตัะตะฒะพะดั postgres ะฒ ะฝะพัะผะฐะปัะฝัะน ัะตะถะธะผ ัะฐะฑะพัั, ะธ ะทะฐะฟััะบะฐะตะผ ัะตะฟะปะธะบะฐัะธั ะฝะฐ ััะพัะพะฝะต barman.


#### ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัะฐะผัะต ัะฒะตะถะธะต ะดะฐะฝะฝัะต postgresql-ัะตัะฒะตัะฐ ั ัะตัะฒะตัะฐ barman

ะพััะฐะฝะฐะฒะปะธะฒะฐะตะผ PostgreSQL ะฝะฐ ัะตัะฒะตัะต ะฑะฐะทั ะดะฐะฝะฝัั
```
systemctl stop postgresql.service
```
ะะตะปะฐัะตะปัะฝะพ ัะพััะฐะฝะธัั ะดะธัะตะบัะพัะธั ั ัะฐะนะปะฐะผะธ ะฑะฐะทั ะดะฐะฝะฝัั: 
```
mv /var/lib/postgresql/13/main /var/lib/postgresql/13/main.old.bak
```
ะะพะผะฐะฝะดั ะทะฐะฟััะบะฐะตะผ ะฝะฐ ัะตัะตัะต barman:
```
barman recover --get-wal --remote-ssh-command 'ssh postgres@pg-cluster01.rs.int' pg_cluster01 latest /var/lib/postgresql/13/main
```

ะะพัะปะต ัะตะณะพ ะฝะฐ ัะตัะฒะตัะต postgres ะฟัะพััะพ ะทะฐะฟััะบะฐะตะผ postgres:
```
systemctl start postgresql.service
```
ะัะพะฒะตััะตะผ, ััะพ ะฒัั ะบะพััะตะบัะฝะพ, ััะพ ะฒัะต ะดะฐะฝะฝัะต ะฟัะธัััััะฒััั. 
ะะพัะปะต ััะพะณะพ ะฒะบะปััะฐะตะผ ัะตะฟะปะธะบะฐัะธั ะฝะฐ ัะตัะฒะตัะต postgres -  ัะฐัะบะพะผะผะตะฝัะธััะตะผ ะพะฟัะธั archive_command ะฒ postgresql.conf, ะฟะตัะตะทะฐะฟััะบะฐะตะผ postgres:
```
systemctl restart postgresql.service
```
ะะตะฟะปะธะบะฐัะธั ะดะพะปะถะฝะฐ ะฟะพะนัะธ, barman ะฟะพะบะฐะถะตั ััะฐัััะพะผ, ััะพ ะฒัั ัะพัะพัะพ:
```
barman check pg_cluster01
```

#### ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะฝะฐ ะบะพะฝะบัะตัะฝัั ะดะฐัั ะฝะฐ ัะตัะฒะตัะต barman ะธะท-ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปั barman:
ะญัะพั ะฒะฐัะธะฐะฝั ัะปะพะถะฝะตะต, ั.ะบ. postgres ะฑัะดะตั ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐัั ัะฒะพั ัะพััะพัะฝะธะต ะธะท wall-ัะฐะนะปะพะฒ, ะฟะตัะตะนะดัั ะฒ ัะตะถะธะผ ัะพะปัะบะพ-ััะตะฝะธะต, "ัะปะพะผะฐะตััั" ัะตะฟะปะธะบะฐัะธั. ะ ััะพะฑั ััะพ ะฒัั ะทะฐัะฐะฑะพัะฐะปะพ - ะฟะพััะตะฑัะตััั ะฑะพะปััะตะต ะบะพะปะธัะตััะฒะพ ะดะตะนััะฒะธะน.

ะพััะฐะฝะฐะฒะปะธะฒะฐะตะผ PostgreSQL ะฝะฐ ัะตัะฒะตัะต ะฑะฐะทั ะดะฐะฝะฝัั
```
systemctl stop postgresql.service
```
ะะตะปะฐัะตะปัะฝะพ ัะพััะฐะฝะธัั ะดะธัะตะบัะพัะธั ั ัะฐะนะปะฐะผะธ ะฑะฐะทั ะดะฐะฝะฝัั: 
```
mv /var/lib/postgresql/13/main /var/lib/postgresql/13/main.old.bak
```

ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฝะฐ ะบะพะฝะบัะตัะฝัั ะดะฐัั:
```
barman recover --get-wal --remote-ssh-command 'ssh postgres@pg-cluster01.rs.int'  --target-time "2023-03-14 11:18:00+10:00" pg_cluster01 20230314T111258 /var/lib/postgresql/13/main
```
ะะดะต 20230314T111258 - ะธะผั ะฑัะบะฐะฟะฐ, ะบะพัะพัะพะต ะฒัะดะฐัั ะบะพะผะฐะฝะดะฐ `barman list-backup pg_cluster01`, ะปะธะฑะพ ััะพ ะธะผั ะผะพะถะตั ะฟัะธะฝะธะผะฐัั ะทะฝะฐัะตะฝะธะต latest - ัะฐะผัะน ะฟะพัะปะตะดะฝะธะน ะฑัะบะฐะฟ.

ะะพัะปะต ัะตะณะพ ะฝะฐ ัะตัะฒะตัะต postgres ะฟัะพััะพ ะทะฐะฟััะบะฐะตะผ postgres:
```
systemctl start postgresql.service
```
ะัะพะฒะตััะตะผ, ััะพ ะฒัั ะบะพััะตะบัะฝะพ, ััะพ ะฒัะต ะดะฐะฝะฝัะต ะฟัะธัััััะฒััั. 

ะะปะธ ะถะต ะผะพะถะตั ะฟะพััะตะฑะพะฒะฐัััั ะทะฐะฟััะบะฐัั postgres ะฒ ัะตะถะธะผะต ะฒะพัััะฐะฝะพะฒะปะตะฝะธั:
ะะฐ ัะตัะตัะต postgres ะทะฐะฟััะบะฐะตะผ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต (ะธะท-ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปั postgres) - ััะพ ะฝะตะพะฑัะทะฐัะตะปัะฝะพ, ะผะพะถะฝะพ ััะฐะทั ะฟัะพััะพ ะทะฐะฟัััะธัั postgres ะบะฐะบ ัะตัะฒะธั, ะฝะพ ะธะฝะพะณะดะฐ ะผะพะถะตั ะฟะพะฝะฐะดะพะฑะธัััั ะธะผะตะฝะฝะพ ััะฐ ะบะพะผะฐะฝะดะฐ:
```
 /usr/lib/postgresql/13/bin/postgres --single -c config_file=/etc/postgresql/13/main/postgresql.conf -D /var/lib/postgresql/13/main -P -d 5
```
7. ะฟะพัะปะต ัะตะณะพ ะฝะฐะถะธะผะฐะตะผ ctrl+d, ะฒััะพะดะธ, ะฒััะพะดะธั ะธะท-ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปั postgres ะธ ัะถะต ะธะท-ะฟะพะด ัััะฐ ะทะฐะฟััะบะฐะตะผ postgres ะบะฐะบ ัะตัะฒะธั:
```
systemctl start postgresql.service
```
ะขัั ะถะต ะทะฐะนะดั ะฒ ะฟะพััะณัะตั ะบะปะธะตะฝัะพะผ ะธ ัะดะตะปะฐะฒ select ะฒ ะฝัะถะฝะพะน ัะฐะฑะปะธัะต - ะผะพะถะฝะพ ัะฒะธะดะตัั ะบะฐะบ ะฟะพัะฒะปััััั (ะฟะพััะตะฟะตะฝะฝะพ) ะทะฐะฟะธัะธ ะดะพ ัะบะฐะทะฐะฝะฝะพะณะพ ะฒัะตะผะตะฝะธ.

ะฃะฑะตะถะดะฐะตะผัั, ััะพ ะฒะตััะธั ะพะฟัะธะผะฐะปัะฝะฐั. ะัะปะธ ะฝะต ะพะฟัะธะผะฐะปัะฝะฐั ะธ ะฝัะถะฝะพ ะพัะบะฐััะฒะฐัั ะฝะฐ ะธะฝัั ะดะฐัั - ัะพ ะทะฐะฝะพะฒะพ ะพััะฐะฝะฐะฒะปะธะฒะฐะตั postgres ะธ ะทะฐะฟััะบะฐะตะผ ะพะฟััั barman recover ั ะฝัะถะฝัะผะธ ะพะฟัะธัะผะธ (ั ะฝัะถะฝัะผ ะฒัะตะผะตะฝะตะผ, ะฝะฐ ะบะพัะพัะพะต ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ)
ะฃะฑะตะดะธะฒัะธัั, ััะพ ะฒะพัััะฐะฝะพะฒะธะปะธัั ะฝะฐ ะฝัะถะฝัั ะฒะตััะธั -  ัะฐัะบะพะผะผะตะฝัะธััะตะผ ะพะฟัะธั archive_command ะฒ postgresql.conf, ะฟะตัะตะทะฐะฟััะบะฐะตะผ postgres:
```
systemctl restart postgresql.service
```

ะะฐะฒะตััะฐะตะผ ะฟัะพัะตัั ะฒะพัััะฐะฝะพะฒะปะตะฝะธั ะฝะฐ Postgres-ะต (ะฒัะต ะดะฐะฝะฝัะต ัะฐะผ ะฒ ัะตะถะธะผะต "ัะพะปัะบะพ ััะตะฝะธะต" ะดะพ ััะพะณะพ ะผะพะผะตะฝัะฐ):
```
postgres=# select pg_wal_replay_resume();
 pg_wal_replay_resume 
----------------------
 
(1 row)
```
ะะพัะปะต ััะพะณะพ ะผะพะถะฝะพ ะฟะธัะฐัั ะฒ ัะฐะฑะปะธัั.
### ะะฐะฝะพะฒะพ ะทะฐะฟััะบะฐะตะผ ัะตะฟะปะธะบะฐัะธั postgres->barman
ะ ัะปััะฐะต, ะตัะปะธ ะผั ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะปะธ ะดะฐะฝะฝัะต ะฝะฐ ัะฐะผัั ัะฒะตะถัั ะดะฐัั (ัะตะท ัะบะฐะทะฐะฝะธั ะพะฟัะธะธ --target-time), ัะพ ััะพั ัะฐะทะดะตะป ัะบะพัะตะต ะฒัะตะณะพ ะฒะฐะผ ะฝะต ะฟะพะฝะฐะดะพะฑะธััั. 
ะะดะฝะฐะบะพ ะตัะปะธ ะฒั ะฒะพัััะฐะฝะฐะฒะปะธะฒะฐะปะธ ะดะฐะฝะฝัะต ะฝะฐ ะบะฐะบัั-ัะพ ะบะพะฝะบัะตัะฝัั ะดะฐัั, ะพัะปะธัะฝัั ะพั ัะฐะผะพะน ะฟะพัะปะตะดะฝะตะน, ัะพ ัะตะฟะปะธะบะฐัะธั ะผะพะถะตั ะฝะต ะทะฐะฟัััะธัััั ััะฐะฝะดะฐััะฝัะผ ัะฟะพัะพะฑะพะผ, ั.ะบ. ะฒะตััะธะธ ััะฐะฝะทะฐะบัะธะน ะฒ barman-ะฝะต ะดะปั ััะพะณะพ ัะตัะฒะตัะฐ ะฑัะดัั ัะฒะตะถะตะต, ัะตะผ ะฒะตััะธะธ ััะฐะฝะทะฐะบัะธะน ะฝะฐ ัะตัะฒะตัะต postgres. ะะพััะพะผั ะฟัะธะดัััั ัะธะฝััะพะฝะธะทะธัะพะฒะฐัั ัะตะฟะปะธะบะฐัะธั ะบะพะผะฐะฝะดะพะน:
```
barman receive-wal --reset pg_cluster01
```
ะัะปะธ ะฒ ะพัะฒะตั ะฟะพะปััะฐะตะผ ะพัะธะฑะบั ะฒะธะดะฐ:
```
barman@pg-cluster02:/root$ barman receive-wal --reset pg_cluster01
ERROR: The receive-wal position is ahead of PostgreSQL current WAL lsn (000000070000000000000029.partial > None)
```
ะขะพ ะฝัะถะฝะพ ัะฑัะฐัั ัะฐะนะปั ะธะท streaming ะธ ะฟะพะฒัะพัะธัั ะฟัะพัะตัั:
```
mkdir /mnt/backup/barman/pg_cluster01/streaming.old/
mv /mnt/backup/barman/pg_cluster01/streaming/* /mnt/backup/barman/pg_cluster01/streaming.old/
barman receive-wal --reset pg_cluster01
```
ะะพะดะพะถะดะฐัั ะฟะฐัั ะผะธะฝัั, ะฟะพะบะฐ ะฝะต ะทะฐะฟัััะธัััั ะฒ barman ะตัั ะพะดะฝะฐ ะพะฟะฟััะบะฐ ัะตะฟะปะธะบะฐัะธะธ. ะ ะทะฐะฟัััะธัั ะฟัะพะฒะตัะบั ััะฐัััะฐ ัะปะพัะฐ:
```
barman check pg_cluster01
```
ะ ัะฐะผ ะดะพะปะถะฝะพ ะฑััั ะฒัั ัะพัะพัะพ.

ะขะฐะบ ะถะต ะผะพะถะตั ะฑััั ะฟะพะฝะฐะดะพะฑะธััั ะบะพะผะฐะฝะดะฐ ะฟะตัะตัะฑะพัะบะธ ะฑะฐะทั barman ะธ, ะผะพะถะตั ะฑััั, ะฟะพะฒัะพัะฝัะน ัะฑัะพั ะธะฝะดะตะบัะพะฒ wal:
```
barman rebuild-xlogdb pg_cluster01
barman receive-wal --reset pg_cluster01
```
### ะะพะทะผะพะถะฝัะต ะพัะธะฑะบะธ
#### archiver errors: FAILED (duplicates: XXX)

=> https://groups.google.com/g/pgbarman/c/0xaSp5o6smU

ะญัะพ ะทะฝะฐัะธั, ััะพ ะฑะฐัะผะฐะฝั ะบัะพ-ัะพ ะฟัะธัะปะฐะป ะบะฐะบะธะต-ัะพ ะฒะฐะปั ะดะฒะฐะถะดั. ะ ะฑะฐัะผะฐะฝ ัะปะพะถะธะป ะธั ะฒ ะดะธัะตะบัะพัะธั `barman_store_home/errors` ะธ ัะตะฟะตัั ัะฐะฟะพัััะตั ะพะฑ ััะพะผ. 
ะะพะถะฝะพ ะทะฐะนัะธ ะธ ะฟะพัะผะพััะตัั ะดะฐัั ัะพะทะดะฐะฝะธั ััะธั ัะฐะนะปะพะฒ (ะพะฝะฐ ะฒ ัะพะผ ัะธัะปะต ะฒ ะธะผะตะฝะธ ัะฐะนะปะฐ ัะพะดะตัะถะธััั - ะฒ ะฟะพัััะธะบัะต). ะะตะปะฐัะตะปัะฝะพ ะฟะพัะฐะทะฑะธัะฐัััั ะบัะพ ะธ ะบะพะณะดะฐ ะตะณะพ ะฟัะธัะปะฐะป. ะะปั ัะตัะตะฝะธั - ะฟัะพััะพ ัะดะฐะปะธัั ััะธ ัะฐะนะปั ะธะท ะดะธัะตะบัะพัะธะธ `errors`.

#### ะะฝะพะถะฐััั wal-ัะฐะนะปั
ะัะปะธ ะฒัะต ััะฐัััั ะฝะพัะผะฐะปัะฝั ะธ ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ ัะพะฒะฟะฐะดะฐัั:
postgres:
```
postgres=# SELECT * FROM pg_stat_replication;
-[ RECORD 1 ]----+------------------------------
pid              | 24668
usesysid         | 1243795
usename          | streaming_barman
application_name | barman_receive_wal
client_addr      | 10.75.232.213
client_hostname  | 
client_port      | 54636
backend_start    | 2025-04-18 09:39:02.200279+10
backend_xmin     | 
state            | streaming
sent_lsn         | 62/9001110
write_lsn        | 62/9000000
flush_lsn        | 62/9000000
replay_lsn       | 
write_lag        | 00:00:05.440091
flush_lag        | 00:00:05.440091
replay_lag       | 06:36:30.991794
sync_priority    | 0
sync_state       | async
```
barman:
```
barman replication-status pg_1c_prim_drsk_ru
Status of streaming clients for server 'pg_1c_prim_drsk_ru':
Current LSN on master: 62/9003138
Number of streaming clients: 1

1. Async WAL streamer
Application name: barman_receive_wal
Sync stage      : 2/3 WAL Sent (min)
Communication   : TCP/IP
IP Address      : 10.75.232.213 / Port: 54636 / Host: -
User name       : streaming_barman
Current state   : streaming (async)
Replication slot: pg_1c_prim_drsk_ru
WAL sender PID  : 24668
Started at      : 2025-04-18 09:39:02.200279+10:00
Sent LSN   : 62/9003138 (diff: 0 B)
Write LSN  : 62/9001110 (diff: -8.0 KiB)
Flush LSN  : 62/9000000 (diff: -12.3 KiB)
```
ะณะดะต:
Sent LSN - ะพัะฟัะฐะฒะปะตะฝะฝัะน ะฒ ัะตะฟะปะธะบะฐัะธั ะธะดะตะฝัะธัะธะบะฐัะพั wal-ะฐ
Write LSN - ะทะฐะฟะธัะฐะฝะฝัะน ะฝะฐ ะบะปะธะตะฝัะต (ะฑะฐัะผะฐะฝะต)
Flush LSN - ัะบะธะฝัััะน ะฝะฐ ะดะธัะบ ะฝะฐ ะบะปะธะตะฝัะต (ะธะท ะบััะฐ ะฒ ะะะฃ)

ะะพ ะตัะปะธ ะฒัั ัะฐะฒะฝะพ wal-ั ะฟะปะพะดัััั ะฝะฐ postgres - ะฝัะถะฝะพ ะฟัะพะฒะตัะธัั, ะผะพะถะตั ะบะฐะบะพะน ัะปะพั ัะตะฟะปะธะบะฐัะธะธ ะพััะฐะปัั ััะฐััะน:
```
postgres=# SELECT * FROM pg_replication_slots;
-[ RECORD 1 ]-------+-------------------
slot_name           | pg_1c_prim_drsk_ru
plugin              |
slot_type           | physical
datoid              |
database            |
temporary           | f
active              | t
active_pid          | 24668
xmin                |
catalog_xmin        |
restart_lsn         | 61/FC000000
confirmed_flush_lsn |
-[ RECORD 2 ]-------+-------------------
slot_name           | barman
plugin              |
slot_type           | physical
datoid              |
database            |
temporary           | f
active              | f
active_pid          |
xmin                |
catalog_xmin        |
restart_lsn         | 4E/DF000000
confirmed_flush_lsn |
```
ะธ ัะดะฐะปะธัั ะฝะตะฝัะถะฝัะน:
```
SELECT pg_drop_replication_slot('barman');
```





=>../index.gmi ๐ ะฒะตัะฝััััั ะบ ะฝะฐัะฐะปั...
