# ะะฐัััะพะนะบะฐ ะบะปะฐััะตัะฐ postgres ัะตัะตะท biha (postgrespro)
## ะะพะณะธะบะฐ ัะฐะฑะพัั

=> https://postgrespro.ru/clusters/biha

# ะฃััะฐะฝะพะฒะบะฐ

## ะะฐัััะฐะธะฒะฐะตะผ ัะตะฟั postgrespro

1. ัะบะฐัะธะฒะฐะตะผ iso ั ะพัะธัะธะฐะปัะฝะพะณะพ ัะฐะนัะฐ:
=> https://repocert.postgrespro.ru/EnterpriseCertified/PostgresProEntCert-13.21.1%2B14.18.1%2B15.13.1%2B16.9.1%2B17.5.1/
2. ะผะพะฝัะธััะตะผ ะดะธัะบ ัะตัะตะท loop
```
mkdir /mnt/loop
mount -o loop /home/aasu/PostgresEnt17/PostgresProEntCert-13.21.1+14.18.1+15.13.1+16.9.1+17.5.1.iso /mnt/loop/
```
3. ะฟัะพะฟะธััะฒะฐะตะผ ัะตะฟะพ
```
cat /etc/apt/sources.list.d/postgres.list
deb [trusted=yes] file:/mnt/loop/astra-smolensk/1.8/ 1.8_x86-64 main]
```
4. ะธะผะฟะพััะธััะตะผ ะบะปััะธ:
```
gpg --import /mnt/loop/keys/GPG-KEY-POSTGRESPRO
apt-key add /mnt/loop/keys/GPG-KEY-POSTGRESPRO
```
## ะฝะฐัััะฐะธะฒะฐะตะผ ัะธะฝััะพะฝะธะทะฐัะธั ะฒัะตะผะตะฝะธ:
ะัะฟะพะปัะทัะตะผ ัะตัะฒะธั ัะธะฝััะพะฝะธะทะฐัะธะธ ะฒ systemd:
```
systemctl enable systemd-timesyncd
systemctl restart systemd-timesyncd
timedatectl status
```

## ะกัะฐะฒะธะผ ะฟะตัะฒัั ะฝะพะดั
```
apt-get update
apt-get install postgrespro-ent-17-contrib
```
### ัะพะทะดะฐัะผ ะฟััั ััะฐะฝะตะฝะธั ะดะฐะฝะฝัั postgres
```
mkdir /data/postgres_data
chown postgres:postgres /data/postgres_data
chmod 700 /data/postgres_data
```
### ะะฐัััะฐะธะฒะฐะตะผ ะฟะฐัะพะปะธ ัะตะฟะปะธะบะฐัะธะธ ะบ ะบะปะฐััะตัั:
ะกัะฐะทั ะธ ะณะตะฝะตัะธััะตะผ ะตะณะพ:
```
apt install pwgen
su postgres
echo "*:*:*:biha_replication_user:$(pwgen -s 16 1)" >> ~/.pgpass
```
### ะะฝะธัะธะฐะปะธะทะธััะตะผ ะบะปะฐััะตั
ะะต ะทะฐะฑัะฒะฐะตะผ, ััะพ ััะพ ะฝะฐะดะพ ะฒัะฟะพะปะฝััั ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปะตะผ postgres:
```
su postgres
cd ~
export PATH=$PATH:/opt/pgpro/ent-17/bin
bihactl init --biha-node-id=1 --host=pg-cluster-01.internal --nquorum=2 --pgdata=/data/postgres_data/ --enable-proxima
```
ะ ะฒัะฒะพะดะต ะฑัะดะตั "ะผะฐะณะธัะตัะบะพะต ัะธัะปะพ" ะฒะธะดะฐ: 
```
dm212234234234235345cGctY2x1c3Rl2323243423Rlcm5hbC32325243534zIgYmloY4234234PTU0MzM=
```
ะทะฐะฟะพะผะธะฝะฐะตะผ ะตะณะพ!

ััะฐัััะตะผ postgres ะฝะฐ ะฟะตัะฒะพะน ะฝะพะดะต:
```
pg_ctl start -D /data/postgres_data/ -l /data/postgres_data/cluster_leader.log
```
### ะฟัะพะฒะตัะบะฐ ััะฐัััะฐ ะฟะตัะฒะพะน ะฝะพะดั
```
echo "SELECT * FROM biha.status_v;"|psql -d biha_db
```
ะฒัะฒะพะด:
```
postgres@pg-cluster-01:~$ echo "SELECT * FROM biha.status_v;"|psql -d biha_db
 id | leader_id | term | online |   state   | last_known_state | since_last_hb
 ----+-----------+------+--------+-----------+------------------+---------------
   1 |         1 |    0 | t      | LEADER_RO | LEADER_RO        |
   (1 ัััะพะบะฐ)
```

## ะะพะฑะฐะฒะปัะตะผ ะฒัะพััั ะฝะพะดั

### ะะพะฒัะพััะตะผ ะฝะฐ ะฒัะพัะพะน ัะต ะถะต ัะฐะณะธ, ััะพ ะธ ะฝะฐ ะฟะตัะฒะพะน ะฝะพะดะต:
1. ะฝะฐัััะพะนะบะฐ ัะตะฟ
2. ะฝะฐัััะพะนะบะฐ ะฒัะตะผะตะฝะธ
3. ะฝะฐัััะพะนะบะฐ ะฟะฐัะพะปั ัะตะฟะปะธะบะฐัะธะธ (ััะฐะฒะธะผ ะขะะข ะะ, ะฐ ะฝะต ะทะฐะฝะพะฒะพ ะณะตะฝะตัะธะผ!)
4. ัะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ ััะฐะฝะตะฝะธั ะดะฐะฝะฝัั

### ะดะพะฑะฐะฒะปัะตะผ ะฝะพะดั 2 ะฒ ะบะปะฐััะตั
ะปะฐััะตั
ะะต ะทะฐะฑัะฒะฐะตะผ, ััะพ ััะพ ะฝะฐะดะพ ะฒัะฟะพะปะฝััั ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปะตะผ postgres (ะทะฝะฐัะตะฝะธะต ะผะฐะณะธัะตัะบะพะณะพ ัะธัะปะฐ ะฑะตััะผ ั ัะฐะณะฐ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ะฟะตัะฒะพะน ะฝะพะดั):
```
su postgres
cd ~
export PATH=$PATH:/opt/pgpro/ent-17/bin
export MAGIC_STRING="dm212234234234235345cGctY2x1c3Rl2323243423Rlcm5hbC32325243534zIgYmloY4234234PTU0MzM="
bihactl  add --biha-node-id=2 --host=pg-cluster-02.internal --magic-string=$MAGIC_STRING --pgdata=/data/postgres_data/ --enable-proxima
```
ััะฐัััะตะผ postgres ะฝะฐ ะฒัะพัะพะน ะฝะพะดะต:
```
pg_ctl start -D /data/postgres_data/ -l /data/postgres_data/cluster_leader.log
```
### ะฟัะพะฒะตัะบะฐ ััะฐัััะฐ ะฟะตัะฒะพะน ะฝะพะดั
```
echo "SELECT * FROM biha.status_v;"|psql -d biha_db
```
ะฒัะฒะพะด:
```
postgres@pg-cluster-02:~$ echo "SELECT * FROM biha.status_v;"|psql -d biha_db
id | leader_id | term | online |   state   | last_known_state |  since_last_hb
----+-----------+------+--------+-----------+------------------+-----------------
1 |         1 |    1 | t      | LEADER_RW | LEADER_RW        | 00:00:00.382625
2 |         1 |    1 | t      | FOLLOWER  | FOLLOWER         |
(2 ัััะพะบะธ)                                                         
```

## ะะพะฑะฐะฒะปัะตะผ ััะตััั ะฝะพะดั

### ะะพะฒัะพััะตะผ ะฝะฐ ััะตััะตะน ัะต ะถะต ัะฐะณะธ, ััะพ ะธ ะฝะฐ ะฟะตัะฒะพะน ะฝะพะดะต:
1. ะฝะฐัััะพะนะบะฐ ัะตะฟ
2. ะฝะฐัััะพะนะบะฐ ะฒัะตะผะตะฝะธ
3. ะฝะฐัััะพะนะบะฐ ะฟะฐัะพะปั ัะตะฟะปะธะบะฐัะธะธ (ััะฐะฒะธะผ ะขะะข ะะ, ะฐ ะฝะต ะทะฐะฝะพะฒะพ ะณะตะฝะตัะธะผ!)
4. ัะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ ััะฐะฝะตะฝะธั ะดะฐะฝะฝัั

### ะดะพะฑะฐะฒะปัะตะผ ะฝะพะดั 3 ะฒ ะบะปะฐััะตั
ะะต ะทะฐะฑัะฒะฐะตะผ, ััะพ ััะพ ะฝะฐะดะพ ะฒัะฟะพะปะฝััั ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปะตะผ postgres (ะทะฝะฐัะตะฝะธะต ะผะฐะณะธัะตัะบะพะณะพ ัะธัะปะฐ ะฑะตััะผ ั ัะฐะณะฐ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ะฟะตัะฒะพะน ะฝะพะดั):
```
su postgres
cd ~
export PATH=$PATH:/opt/pgpro/ent-17/bin
export MAGIC_STRING="dm212234234234235345cGctY2x1c3Rl2323243423Rlcm5hbC32325243534zIgYmloY4234234PTU0MzM="
bihactl  add --biha-node-id=3 --host=pg-cluster-03.internal --magic-string=$MAGIC_STRING --pgdata=/data/postgres_data/ --enable-proxima
```
ััะฐัััะตะผ postgres ะฝะฐ ััะตััะตะน ะฝะพะดะต:
```
pg_ctl start -D /data/postgres_data/ -l /data/postgres_data/cluster_leader.log
```
### ะฟัะพะฒะตัะบะฐ ััะฐัััะฐ ะฟะตัะฒะพะน ะฝะพะดั
```
echo "SELECT * FROM biha.status_v;"|psql -d biha_db
```
ะฒัะฒะพะด:
```
postgres@pg-cluster-03:~$ echo "SELECT * FROM biha.status_v;"|psql -d biha_db
id | leader_id | term | online |   state   | last_known_state | since_last_hb
----+-----------+------+--------+-----------+------------------+----------------
1 |         1 |    2 | t      | LEADER_RW | LEADER_RW        | 00:00:00.24086
2 |         1 |    2 | t      | FOLLOWER  | FOLLOWER         | 00:00:01.24086
3 |         1 |    2 | t      | FOLLOWER  | FOLLOWER         |
(3 ัััะพะบะธ)            
```

## ะะพะฑะฐะฒะปะตะฝะธะต ะฒัะตั ะฝะพะด ะบะปะฐััะตัะฐ ะฒ ะฐะฒัะพะทะฐะณััะทะบั
ะงัะพะฑั ะฟัะธ ะทะฐะฟััะบะต ะบะพััะตะบัะฝะพ ะทะฐะฟััะบะฐะปะธัั ะฟะพััะณัะตัั ะบะปะฐััะตัะฐ, ะฝัะถะฝะพ:
ะกะฝะฐัะฐะปะฐ ะฝะฐ ะฟะตัะฒะพะน ะฝะพะดะต (ะฝะฐ ะปะธะดะตัะต):

1. ะกะพะทะดะฐัั ัะฐะนะป /etc/default/postgrespro-ent-17 ั ัะพะดะตัะถะธะผัะผ:
```
PGDATA=/data/postgres_data/
```
ะญัะพั ัะฐะนะป ะฟะพะดััะณะธะฒะฐะตััั ัะตัะฒะธัะพะผ ะฟะพััะณัะตัะฐ. ะกะพะพัะฒะตัััะฒะตะฝะฝะพ ัะฐะผ ั ะฝะฐั ะดะฐะฝะฝัะต ะบะปะฐััะตัะฐ.

2. ะะบะปััะฐะตะผ ัะตัะฒะธั (ะพะฑััะฝะพ ะดะพะปะถะตะฝ ะฑััั ะฒะบะปััะตะฝ, ะฝะพ ะฝะฐ ะฒััะบะธะน ัะปััะฐะน) ะธ ััะฐัััะตะผ ัะตัะฒะธั:
```
systemctl enable postgrespro-ent-17.service
systemctl start postgrespro-ent-17.service
```

3. ะขะพ ะถะต ัะฐะผะพะต ะฟะพะฒัะพัะธัั ะฝะฐ ะพััะฐะฒัะธััั ะฝะพะดะฐั ะบะปะฐััะตัะฐ.

## ะะฐัััะพะนะบะฐ proxima
=> https://postgrespro.ru/docs/enterprise/17/proxima#PROXIMA-OPERATION-WITH-BIHA

proxima โ ััะพ ัะฐััะธัะตะฝะธะต Postgres Pro Enterprise, ะพะฑัะตะดะธะฝัััะตะต ััะฝะบัะธะพะฝะฐะปัะฝะพััั ะฟัะพะบัะธ-ัะตัะฒะตัะฐ ะธ ะฟัะปะฐ ัะพะตะดะธะฝะตะฝะธะน.

ะะฐััะธัะตะฝะธะต proxima ะฟัะตะดะพััะฐะฒะปัะตั ัะปะตะดัััะธะต ะฟะพััั ะดะปั ะพะฑัะฐะฑะพัะบะธ ะบะปะธะตะฝััะบะธั ัะตะฐะฝัะพะฒ:

ะะพัั Proxy-to-Leader (P2L) ะฟะตัะตะฝะฐะฟัะฐะฒะปัะตั ะฒัั ะฝะฐะณััะทะบั ะฝะฐ ะฒะตะดััะธะน ัะทะตะป (ะปะธะดะตั). ะะพะผะตั ะฟะพััะฐ ะฟะพ ัะผะพะปัะฐะฝะธั โ 4545, ะตะณะพ ะผะพะถะฝะพ
ะธะทะผะตะฝะธัั ั ะฟะพะผะพััั ะฟะฐัะฐะผะตััะฐ proxima.port.

ะะพัั Proxy-to-Follower (P2F) ัะฐัะฟัะตะดะตะปัะตั ัะธัะฐัััั ะฝะฐะณััะทะบั ะผะตะถะดั ัะตะฟะปะธะบะฐะผะธ ะฒ ะบะปะฐััะตัะต. ะะพะผะตั ะฟะพััะฐ ะฟะพ ัะผะพะปัะฐะฝะธั โ 4547,
ะตะณะพ ะผะพะถะฝะพ ะธะทะผะตะฝะธัั ั ะฟะพะผะพััั ะฟะฐัะฐะผะตััะฐ proxima.p2f_port.

ะงัะพะฑั ัะฐัะฟัะตะดะตะปะธัั ะฝะฐะณััะทะบั ะผะตะถะดั ัะทะปะฐะผะธ ะบะปะฐััะตัะฐ, ะฝะฐัััะพะนัะต ะบะปะธะตะฝััะบะพะต ะฟัะธะปะพะถะตะฝะธะต ัะฐะบะธะผ ะพะฑัะฐะทะพะผ, ััะพะฑั ะฟะธัััะฐั ะฝะฐะณััะทะบะฐ
ะฝะฐะฟัะฐะฒะปัะปะฐัั ะฝะฐ ะฟะพัั P2L, ะฐ ัะธัะฐััะฐั โ ะฝะฐ ะฟะพัั P2F. ะะฐ ะฟะพะดัะพะฑะฝะพะน ะธะฝัะพัะผะฐัะธะตะน ะพะฑัะฐัะธัะตัั ะบ ัะฐะทะดะตะปั ะะฐัััะพะนะบะฐ ัะฐัะฟัะตะดะตะปะตะฝะธั
ะฝะฐะณััะทะบะธ.

## ะฝะฐัััะพะนะบะฐ ะฟะพะด 1ะก
1. ัััะธะผ ะฒัะต ะฝะพะดั ะฟะพ ะพัะตัะตะดะธ, ะฝะฐัะธะฝะฐั ั ัะตะฟะปะธะบ, ะทะฐะบะฐะฝัะธะฒะฐั ะผะฐััะตัะพะผ
```
systemctl stop postgrespro-ent-17.service
```
2. ะฝะฐ ะบะฐะถะดะพะน ะฝะพะดะต ะฒัะฟะพะปะฝัะตะผ (ะณะดะต /data/postgres_data - ะฟััั, ะณะดะต postgres ััะฐะฝะธั ะดะฐะฝะฝัะต):
```
cd /data/postgres_data
su postgres
export PATH=$PATH:/opt/pgpro/ent-17/bin
cp postgresql.conf postgresql.conf.bak.before_1c_tune
pgpro_tune --preset=1c.tune -D /data/postgres_data/
```
3. ะพัะบััะฒะฐะตะผ ะธะทะผะตะฝัะฝะฝัะน ัะฐะนะป /data/postgres_data/postgresql.conf, ะฟัะพะผะฐััะฒะฐะตะผ ะฒะฝะธะท ะธ ัะฐัะบะพะผะผะตะฝัะธััะตะผ ะฝัะถะฝัั ะพะฟัะธั (ะฒ ะทะฐะฒะธัะธะผะพััะธ 
ะพั ะฝะพัะธัะตะปะตะน):
```
#random_page_cost = '1.1' # for NVMe SSD
#random_page_cost = 1.3  # for SATA SSD
random_page_cost = 4.0  # for HDD
```
4. ะทะฐะฟััะบะฐะตะผ ะฒัะต ะฝะพะดั ะฟะพ ะพัะตัะตะดะธ, ะฝะฐัะธะฝะฐั ั ะผะฐััะตัะฐ, ะทะฐะบะฐะฝัะธะฒะฐั ัะตะฟะปะธะบะฐะผะธ. ะะฐะถะดัั ะฝะพะดั ะทะฐะฟััะบะฐะตะผ ัะพะปัะบะพ ะดะพะถะดะฐะฒัะธัั ััะฟะตัะฝะพะณะพ
ััะฐััะฐ ะฟัะตะดัะดััะตะน ะฝะพะดั:
```
systemctl start postgrespro-ent-17.service
```

## ะะตัะตะธะฝะธัะธะฐะปะธะทะฐัะธั ั ะฝัะปั ะฒ ัะปััะฐะต ัะฑะพั
ะัะปะธ ััะพ-ัะพ ะฟะพัะปะพ ะฝะต ัะฐะบ ะธ ะผั ัะตัะธะปะธ ะทะฐะฝะพะฒะพ ัะพะทะดะฐัั ะบะปะฐััะตั, ัะพ ะฟะพะฒัะพััะตะผ ะฝะฐ ะะกะะฅ ะฝะพะดะฐั,
ะฝะฐัะธะฝะฐั ั ะฟะพัะปะตะดะฝะตะน: 3, 2, 1:

ะกะฝะพัะธะผ ะฒัะต ะฟะฐะบะตัั ะฟะพััะณัะตัะฐ:
```
apt purge postgrespro-ent-17-client postgrespro-ent-17-contrib postgrespro-ent-17-libs postgrespro-ent-17-server 
```
ะกะผะพััะธะผ ะตััั ะปะธ ะทะฐะฟััะตะฝะฝัะต ะฟัะพัะตััั, ะตัะปะธ ะตััั - ะบะธะปัะตะผ ะธั ะฒัะต:
```
ps aux|grep postgre
kill 573326
```
ะฟะตัะตะฟัะพะฒะตััะตะผ, ััะพ ะฝะตั ะทะฐะฟััะตะฝะฝัั ะฟัะพัะตััะพะฒ, ะฟะพัะปะต ััะพะณะพ ัะดะฐะปัะตะผ ัะพะดะตัะถะธะผะพะต ะดะธัะตะบัะพัะธะธ ั ะดะฐะฝะฝัะผะธ:
```
rm -rf /data/postgres_data/*
```
ะฟะพะฒัะพััะตะผ ะฟัะฝะบัั, ะฝะฐัะธะฝะฐั ั ัะฐะทะดะตะปะฐ "ะกัะฐะฒะธะผ ะฟะตัะฒัั ะฝะพะดั"








#FIXME ะดะฐะปะตะต - ััะฐัะพะต!





=>../index.gmi ๐ ะฒะตัะฝััััั ะบ ะฝะฐัะฐะปั...
