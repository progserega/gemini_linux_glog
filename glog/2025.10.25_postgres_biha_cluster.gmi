# ะะฐัััะพะนะบะฐ ะบะปะฐััะตัะฐ postgres ัะตัะตะท biha (postgrespro)
## ะะพะณะธะบะฐ ัะฐะฑะพัั

=> https://postgrespro.ru/clusters/biha

# ะฃััะฐะฝะพะฒะบะฐ

## ะะฐัััะฐะธะฒะฐะตะผ ัะตะฟั postgrespro

1. ัะบะฐัะธะฒะฐะตะผ iso ั ะพัะธัะธะฐะปัะฝะพะณะพ ัะฐะนัะฐ:
=> https://repocert.postgrespro.ru/EnterpriseCertified/PostgresProEntCert-13.21.1%2B14.18.1%2B15.13.1%2B16.9.1%2B17.5.1/
2. ะผะพะฝัะธััะตะผ ะดะธัะบ ัะตัะตะท loop
```
mkdir /mnt/loop
mount -o loop /home/aasu/PostgresEnt17/PostgresProEntCert-13.21.1+14.18.1+15.13.1+16.9.1+17.5.1.iso /mnt/loop/
```
3. ะฟัะพะฟะธััะฒะฐะตะผ ัะตะฟะพ
```
cat /etc/apt/sources.list.d/postgres.list
deb [trusted=yes] file:/mnt/loop/astra-smolensk/1.8/ 1.8_x86-64 main]
```
4. ะธะผะฟะพััะธััะตะผ ะบะปััะธ:
```
gpg --import /mnt/loop/keys/GPG-KEY-POSTGRESPRO
apt-key add /mnt/loop/keys/GPG-KEY-POSTGRESPRO
```
## ะฝะฐัััะฐะธะฒะฐะตะผ ัะธะฝััะพะฝะธะทะฐัะธั ะฒัะตะผะตะฝะธ:
ะัะฟะพะปัะทัะตะผ ัะตัะฒะธั ัะธะฝััะพะฝะธะทะฐัะธะธ ะฒ systemd:
```
systemctl enable systemd-timesyncd
systemctl restart systemd-timesyncd
timedatectl status
```

## ะกัะฐะฒะธะผ ะฟะตัะฒัั ะฝะพะดั
```
apt-get update
apt-get install postgrespro-ent-17-contrib
```
### ัะพะทะดะฐัะผ ะฟััั ััะฐะฝะตะฝะธั ะดะฐะฝะฝัั postgres
```
mkdir /data/postgres_data
chown postgres:postgres /data/postgres_data
chmod 700 /data/postgres_data
```
### ะะฐัััะฐะธะฒะฐะตะผ ะฟะฐัะพะปะธ ัะตะฟะปะธะบะฐัะธะธ ะบ ะบะปะฐััะตัั:
ะกัะฐะทั ะธ ะณะตะฝะตัะธััะตะผ ะตะณะพ:
```
apt install pwgen
su postgres
echo "*:*:*:biha_replication_user:$(pwgen -s 16 1)" >> ~/.pgpass
```
### ะะฝะธัะธะฐะปะธะทะธััะตะผ ะบะปะฐััะตั
ะะต ะทะฐะฑัะฒะฐะตะผ, ััะพ ััะพ ะฝะฐะดะพ ะฒัะฟะพะปะฝััั ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปะตะผ postgres:
```
su postgres
cd ~
export PATH=$PATH:/opt/pgpro/ent-17/bin
bihactl init --biha-node-id=1 --host=pg-cluster-01.internal --nquorum=2 --pgdata=/data/postgres_data/ --enable-proxima
```
ะ ะฒัะฒะพะดะต ะฑัะดะตั "ะผะฐะณะธัะตัะบะพะต ัะธัะปะพ" ะฒะธะดะฐ: 
```
dm212234234234235345cGctY2x1c3Rl2323243423Rlcm5hbC32325243534zIgYmloY4234234PTU0MzM=
```
ะทะฐะฟะพะผะธะฝะฐะตะผ ะตะณะพ!

ะะพะฑะฐะฒะปัะตะผ ะดะพัััะฟั ั ะปะพะบะฐะปะบะธ ะฟะพะด ะฟะฐัะพะปัะผะธ - ะดะพะฑะฐะฒะปัะตะผ ะฒ ัะฐะนะป /data/postgres_data/pg_hba.conf:
```
# from local net:
host            all             all             0.0.0.0/0       md5
```
ััะฐัััะตะผ postgres ะฝะฐ ะฟะตัะฒะพะน ะฝะพะดะต (ะฟะพะด root):

```
systemctl enable postgrespro-ent-17.service
systemctl start postgrespro-ent-17.service
```
### ะฟัะพะฒะตัะบะฐ ััะฐัััะฐ ะฟะตัะฒะพะน ะฝะพะดั
```
echo "SELECT * FROM biha.status_v;"|psql -d biha_db
```
ะฒัะฒะพะด:
```
postgres@pg-cluster-01:~$ echo "SELECT * FROM biha.status_v;"|psql -d biha_db
 id | leader_id | term | online |   state   | last_known_state | since_last_hb
 ----+-----------+------+--------+-----------+------------------+---------------
   1 |         1 |    0 | t      | LEADER_RO | LEADER_RO        |
   (1 ัััะพะบะฐ)
```

## ะะพะฑะฐะฒะปัะตะผ ะฒัะพััั ะฝะพะดั

### ะะพะฒัะพััะตะผ ะฝะฐ ะฒัะพัะพะน ัะต ะถะต ัะฐะณะธ, ััะพ ะธ ะฝะฐ ะฟะตัะฒะพะน ะฝะพะดะต:
1. ะฝะฐัััะพะนะบะฐ ัะตะฟ
2. ะฝะฐัััะพะนะบะฐ ะฒัะตะผะตะฝะธ
3. ะฝะฐัััะพะนะบะฐ ะฟะฐัะพะปั ัะตะฟะปะธะบะฐัะธะธ (ััะฐะฒะธะผ ะขะะข ะะ, ะฐ ะฝะต ะทะฐะฝะพะฒะพ ะณะตะฝะตัะธะผ!)
4. ัะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ ััะฐะฝะตะฝะธั ะดะฐะฝะฝัั

### ะดะพะฑะฐะฒะปัะตะผ ะฝะพะดั 2 ะฒ ะบะปะฐััะตั
ะปะฐััะตั
ะะต ะทะฐะฑัะฒะฐะตะผ, ััะพ ััะพ ะฝะฐะดะพ ะฒัะฟะพะปะฝััั ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปะตะผ postgres (ะทะฝะฐัะตะฝะธะต ะผะฐะณะธัะตัะบะพะณะพ ัะธัะปะฐ ะฑะตััะผ ั ัะฐะณะฐ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ะฟะตัะฒะพะน ะฝะพะดั):
```
su postgres
cd ~
export PATH=$PATH:/opt/pgpro/ent-17/bin
export MAGIC_STRING="dm212234234234235345cGctY2x1c3Rl2323243423Rlcm5hbC32325243534zIgYmloY4234234PTU0MzM="
bihactl  add --biha-node-id=2 --host=pg-cluster-02.internal --magic-string=$MAGIC_STRING --pgdata=/data/postgres_data/ --enable-proxima
```
ััะฐัััะตะผ postgres ะฝะฐ ะฒัะพัะพะน ะฝะพะดะต (ะฟะพะด root):
```
systemctl enable postgrespro-ent-17.service
systemctl start postgrespro-ent-17.service
```
### ะฟัะพะฒะตัะบะฐ ััะฐัััะฐ ะฟะตัะฒะพะน ะฝะพะดั
```
echo "SELECT * FROM biha.status_v;"|psql -d biha_db
```
ะฒัะฒะพะด:
```
postgres@pg-cluster-02:~$ echo "SELECT * FROM biha.status_v;"|psql -d biha_db
id | leader_id | term | online |   state   | last_known_state |  since_last_hb
----+-----------+------+--------+-----------+------------------+-----------------
1 |         1 |    1 | t      | LEADER_RW | LEADER_RW        | 00:00:00.382625
2 |         1 |    1 | t      | FOLLOWER  | FOLLOWER         |
(2 ัััะพะบะธ)                                                         
```

## ะะพะฑะฐะฒะปัะตะผ ััะตััั ะฝะพะดั

### ะะพะฒัะพััะตะผ ะฝะฐ ััะตััะตะน ัะต ะถะต ัะฐะณะธ, ััะพ ะธ ะฝะฐ ะฟะตัะฒะพะน ะฝะพะดะต:
1. ะฝะฐัััะพะนะบะฐ ัะตะฟ
2. ะฝะฐัััะพะนะบะฐ ะฒัะตะผะตะฝะธ
3. ะฝะฐัััะพะนะบะฐ ะฟะฐัะพะปั ัะตะฟะปะธะบะฐัะธะธ (ััะฐะฒะธะผ ะขะะข ะะ, ะฐ ะฝะต ะทะฐะฝะพะฒะพ ะณะตะฝะตัะธะผ!)
4. ัะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ ััะฐะฝะตะฝะธั ะดะฐะฝะฝัั

### ะดะพะฑะฐะฒะปัะตะผ ะฝะพะดั 3 ะฒ ะบะปะฐััะตั
ะะต ะทะฐะฑัะฒะฐะตะผ, ััะพ ััะพ ะฝะฐะดะพ ะฒัะฟะพะปะฝััั ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปะตะผ postgres (ะทะฝะฐัะตะฝะธะต ะผะฐะณะธัะตัะบะพะณะพ ัะธัะปะฐ ะฑะตััะผ ั ัะฐะณะฐ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ ะฟะตัะฒะพะน ะฝะพะดั):
```
su postgres
cd ~
export PATH=$PATH:/opt/pgpro/ent-17/bin
export MAGIC_STRING="dm212234234234235345cGctY2x1c3Rl2323243423Rlcm5hbC32325243534zIgYmloY4234234PTU0MzM="
bihactl  add --biha-node-id=3 --host=pg-cluster-03.internal --magic-string=$MAGIC_STRING --pgdata=/data/postgres_data/ --enable-proxima
```
ััะฐัััะตะผ postgres ะฝะฐ ััะตััะตะน ะฝะพะดะต (ะฟะพะด root):
```
systemctl enable postgrespro-ent-17.service
systemctl start postgrespro-ent-17.service
```
### ะฟัะพะฒะตัะบะฐ ััะฐัััะฐ ะฟะตัะฒะพะน ะฝะพะดั
```
echo "SELECT * FROM biha.status_v;"|psql -d biha_db
```
ะฒัะฒะพะด:
```
postgres@pg-cluster-03:~$ echo "SELECT * FROM biha.status_v;"|psql -d biha_db
id | leader_id | term | online |   state   | last_known_state | since_last_hb
----+-----------+------+--------+-----------+------------------+----------------
1 |         1 |    2 | t      | LEADER_RW | LEADER_RW        | 00:00:00.24086
2 |         1 |    2 | t      | FOLLOWER  | FOLLOWER         | 00:00:01.24086
3 |         1 |    2 | t      | FOLLOWER  | FOLLOWER         |
(3 ัััะพะบะธ)            
```

## ะะพะฑะฐะฒะปะตะฝะธะต ะฒัะตั ะฝะพะด ะบะปะฐััะตัะฐ ะฒ ะฐะฒัะพะทะฐะณััะทะบั
ะงัะพะฑั ะฟัะธ ะทะฐะฟััะบะต ะบะพััะตะบัะฝะพ ะทะฐะฟััะบะฐะปะธัั ะฟะพััะณัะตัั ะบะปะฐััะตัะฐ, ะฝัะถะฝะพ:
ะกะฝะฐัะฐะปะฐ ะฝะฐ ะฟะตัะฒะพะน ะฝะพะดะต (ะฝะฐ ะปะธะดะตัะต):

1. ะกะพะทะดะฐัั ัะฐะนะป /etc/default/postgrespro-ent-17 ั ัะพะดะตัะถะธะผัะผ:
```
PGDATA=/data/postgres_data/
```
ะญัะพั ัะฐะนะป ะฟะพะดััะณะธะฒะฐะตััั ัะตัะฒะธัะพะผ ะฟะพััะณัะตัะฐ. ะกะพะพัะฒะตัััะฒะตะฝะฝะพ ัะฐะผ ั ะฝะฐั ะดะฐะฝะฝัะต ะบะปะฐััะตัะฐ.

2. ะะบะปััะฐะตะผ ัะตัะฒะธั (ะพะฑััะฝะพ ะดะพะปะถะตะฝ ะฑััั ะฒะบะปััะตะฝ, ะฝะพ ะฝะฐ ะฒััะบะธะน ัะปััะฐะน) ะธ ััะฐัััะตะผ ัะตัะฒะธั:
```
systemctl enable postgrespro-ent-17.service
systemctl start postgrespro-ent-17.service
```

3. ะขะพ ะถะต ัะฐะผะพะต ะฟะพะฒัะพัะธัั ะฝะฐ ะพััะฐะฒัะธััั ะฝะพะดะฐั ะบะปะฐััะตัะฐ.

## ะะฐัััะพะนะบะฐ proxima
=> https://postgrespro.ru/docs/enterprise/17/proxima#PROXIMA-OPERATION-WITH-BIHA

proxima โ ััะพ ัะฐััะธัะตะฝะธะต Postgres Pro Enterprise, ะพะฑัะตะดะธะฝัััะตะต ััะฝะบัะธะพะฝะฐะปัะฝะพััั ะฟัะพะบัะธ-ัะตัะฒะตัะฐ ะธ ะฟัะปะฐ ัะพะตะดะธะฝะตะฝะธะน.

ะะฐััะธัะตะฝะธะต proxima ะฟัะตะดะพััะฐะฒะปัะตั ัะปะตะดัััะธะต ะฟะพััั ะดะปั ะพะฑัะฐะฑะพัะบะธ ะบะปะธะตะฝััะบะธั ัะตะฐะฝัะพะฒ:

ะะพัั Proxy-to-Leader (P2L) ะฟะตัะตะฝะฐะฟัะฐะฒะปัะตั ะฒัั ะฝะฐะณััะทะบั ะฝะฐ ะฒะตะดััะธะน ัะทะตะป (ะปะธะดะตั). ะะพะผะตั ะฟะพััะฐ ะฟะพ ัะผะพะปัะฐะฝะธั โ 4545, ะตะณะพ ะผะพะถะฝะพ
ะธะทะผะตะฝะธัั ั ะฟะพะผะพััั ะฟะฐัะฐะผะตััะฐ proxima.port.

ะะพัั Proxy-to-Follower (P2F) ัะฐัะฟัะตะดะตะปัะตั ัะธัะฐัััั ะฝะฐะณััะทะบั ะผะตะถะดั ัะตะฟะปะธะบะฐะผะธ ะฒ ะบะปะฐััะตัะต. ะะพะผะตั ะฟะพััะฐ ะฟะพ ัะผะพะปัะฐะฝะธั โ 4547,
ะตะณะพ ะผะพะถะฝะพ ะธะทะผะตะฝะธัั ั ะฟะพะผะพััั ะฟะฐัะฐะผะตััะฐ proxima.p2f_port.

ะงัะพะฑั ัะฐัะฟัะตะดะตะปะธัั ะฝะฐะณััะทะบั ะผะตะถะดั ัะทะปะฐะผะธ ะบะปะฐััะตัะฐ, ะฝะฐัััะพะนัะต ะบะปะธะตะฝััะบะพะต ะฟัะธะปะพะถะตะฝะธะต ัะฐะบะธะผ ะพะฑัะฐะทะพะผ, ััะพะฑั ะฟะธัััะฐั ะฝะฐะณััะทะบะฐ
ะฝะฐะฟัะฐะฒะปัะปะฐัั ะฝะฐ ะฟะพัั P2L, ะฐ ัะธัะฐััะฐั โ ะฝะฐ ะฟะพัั P2F. ะะฐ ะฟะพะดัะพะฑะฝะพะน ะธะฝัะพัะผะฐัะธะตะน ะพะฑัะฐัะธัะตัั ะบ ัะฐะทะดะตะปั ะะฐัััะพะนะบะฐ ัะฐัะฟัะตะดะตะปะตะฝะธั
ะฝะฐะณััะทะบะธ.

## ะฝะฐัััะพะนะบะฐ ะฟะพะด 1ะก
1. ัััะธะผ ะฒัะต ะฝะพะดั ะฟะพ ะพัะตัะตะดะธ, ะฝะฐัะธะฝะฐั ั ัะตะฟะปะธะบ, ะทะฐะบะฐะฝัะธะฒะฐั ะผะฐััะตัะพะผ
```
systemctl stop postgrespro-ent-17.service
```
2. ะฝะฐ ะบะฐะถะดะพะน ะฝะพะดะต ะฒัะฟะพะปะฝัะตะผ (ะณะดะต /data/postgres_data - ะฟััั, ะณะดะต postgres ััะฐะฝะธั ะดะฐะฝะฝัะต):
```
cd /data/postgres_data
su postgres
export PATH=$PATH:/opt/pgpro/ent-17/bin
cp postgresql.conf postgresql.conf.bak.before_1c_tune
pgpro_tune --preset=1c.tune -D /data/postgres_data/
```
3. ะพัะบััะฒะฐะตะผ ะธะทะผะตะฝัะฝะฝัะน ัะฐะนะป /data/postgres_data/postgresql.conf, ะฟัะพะผะฐััะฒะฐะตะผ ะฒะฝะธะท ะธ ัะฐัะบะพะผะผะตะฝัะธััะตะผ ะฝัะถะฝัั ะพะฟัะธั (ะฒ ะทะฐะฒะธัะธะผะพััะธ 
ะพั ะฝะพัะธัะตะปะตะน):
```
#random_page_cost = '1.1' # for NVMe SSD
#random_page_cost = 1.3  # for SATA SSD
random_page_cost = 4.0  # for HDD
```
4. ะทะฐะฟััะบะฐะตะผ ะฒัะต ะฝะพะดั ะฟะพ ะพัะตัะตะดะธ, ะฝะฐัะธะฝะฐั ั ะผะฐััะตัะฐ, ะทะฐะบะฐะฝัะธะฒะฐั ัะตะฟะปะธะบะฐะผะธ. ะะฐะถะดัั ะฝะพะดั ะทะฐะฟััะบะฐะตะผ ัะพะปัะบะพ ะดะพะถะดะฐะฒัะธัั ััะฟะตัะฝะพะณะพ
ััะฐััะฐ ะฟัะตะดัะดััะตะน ะฝะพะดั:
```
systemctl start postgrespro-ent-17.service
```

## ะกะฑะพะธ
### ะ ัะปััะฐะต ัะฑะพั ะพะดะฝะพะน ะฝะพะดั - ะฟะตัะตะผะตะพัะบะฐ ัะพััะพัะฝะธั
### ะะตัะตะฟะพะดะบะปััะฐะตะผ ะฝะพะดั ะฒ ะบะปะฐััะตั
ะะปั ะฟัะธะผะตัะฐ ัะดะฐะปะธะผ ะฝะพะดั ั id=2 ะธะท ะบะปะฐััะตัะฐ, ะณะดะต ะปะธะดะตั ะธะผะตะตั id=3.

ะกะฝะฐัะฐะปะฐ ะพััะฐะฝะฐะฒะปะธะฒะฐะตะผ postgres ะฝะฐ ะฝะพะดะต 2:
```
systemctl stop postgrespro-ent-17.service
```
ะัะพะฒะตััะตะผ ััะฐััั ะบะปะฐััะตัะฐ ะฝะฐ ะปะธะดะตัะต (ะฝะพะดะฐ 3):
```
postgres@pg-cluster-03:/data/postgres_data/pg_wal$ echo "SELECT * FROM biha.status_v;"|psql -d biha_db
id | leader_id | term | online |   state   | last_known_state | since_last_hb
----+-----------+------+--------+-----------+------------------+---------------
1 |         3 |    5 | f      | UNKNOWN   | UNKNOWN          |
2 |         3 |    9 | f      | UNKNOWN   | UNKNOWN          |
3 |         3 |    9 | t      | LEADER_RO | LEADER_RO        |
(3 ัััะพะบะธ)

postgres@pg-cluster-03:/data/postgres_data/pg_wal$
```
ะะตัะตะผะตัะฐะตะผ ะฒัั ัะพะดะตัะถะธะผะพะต ะฒ ะดะธัะตะบัะพัะธะธ ะดะฐะฝะฝัั ะฝะฐ ะะะะ 2 (ะะะะะะะะ! ะะผะตะฝะฝะพ ะฝะฐ ะฒัะพัะพะน, ะฐ ะฝะต ะฝะฐ ะปะธะดะตัะต!!!):
```
sudo su
mv /data/postgres_data /data/postgres_data.old
mkdir /data/postgres_data
chown postgres /data/postgres_data
chmod 700 /data/postgres_data
```
ะะฐ ะปะธะดะตัะต (ะฝะพะดะฐ 3) - ะทะฐะฟััะบะฐะตะผ ะบะพะผะฐะฝะดั ัะดะฐะปะตะฝะธั ะฝะพะดั:
```
su postgres
export PATH=$PATH:/opt/pgpro/ent-17/bin
echo "SELECT biha.remove_node(2);"|psql -d biha_db
```
ะฒัะฒะพะด ะบะพะผะฐะฝะดั:
```
remove_node
-------------
t
(1 ัััะพะบะฐ)
```
ะฟัะพะฒะตััะตะผ ััะฐััั ะบะปะฐััะตัะฐ:
```
postgres@pg-cluster-03:/data/postgres_data/pg_wal$ echo "SELECT * FROM biha.status_v;"|psql -d biha_db
id | leader_id | term | online |   state   | last_known_state | since_last_hb
----+-----------+------+--------+-----------+------------------+---------------
1 |         3 |    5 | f      | UNKNOWN   | UNKNOWN          |
3 |         3 |   10 | t      | LEADER_RO | LEADER_RO        |
(2 ัััะพะบะธ)
```
ัะดะฐะปะธะปะฐัั ะฝะพะดะฐ. ะขะตะฟะตัั ะฝะฐ ะฝะพะดะต 2 ะดะพะฑะฐะฒะปัะตะผ ะตั ะฒ ะบะปะฐััะตั ะทะฐะฝะพะฒะพ (ะฟะพััั - ะฟะพ-ัะผะพะปัะฐะฝะธั, ะผะฐะณะธัะตัะบะพะต ัะธัะปะพ ะฝะต ะธัะฟะพะปัะทัะตะผ, ั.ะบ ะฒ ะฝะฐัะตะผ
ัะปััะฐะต ะปะธะดะตั ัะผะตะฝะธะปัั - ั 1 ะฝะฐ 3). ะะฐะถะฝะพ ะทะฐะฟััะบะฐัั ะบะพะผะฐะฝะดั ะฒ ะดะพะผะฐัะฝะตะผ ะบะฐัะฐะปะพะณะต ะฟะพะปัะทะพะฒะฐัะตะปั postgres, ััะพะฑั ะปะพะณ ัะฐะนะป ัะพะทะดะฐะปัั ะฒ
ัะตะบััะตะผ ะบะฐัะฐะปะพะณะต, ะฐ ะฝะต ะฒ ะบะฐัะฐะปะพะณะต ะดะฐะฝะฝัั ะฟะพััะณัะตัะฐ:
```
su postgres
export PATH=$PATH:/opt/pgpro/ent-17/bin
cd ~
bihactl  add --biha-node-id=2 --host=pg-cluster-02.internal --use-leader "host=pg-cluster-03.internal port=5432 biha-port=5433" --pgdata=/data/postgres_data/ --enable-proxima
```
ะบะพะผะฐะฝะดะฐ ะฟะพะดะฒะธัะฝะตั ะฝะฐะดะพะปะณะพ, ั.ะบ. ะฟัะพะธััะพะดะธั ัะตะฟะปะธะบะฐัะธั ะดะฐะฝะฝัั ั ะปะธะดะตัะฐ. ะ ัะปะพะฒั, ััะพะฑั ัะตะฟะปะธะบะฐัะธั ัะฐะฑะพัะฐะปะฐ - ะฝัะถะฝะพ ัะดะพััะพะฒะตัะธัััั,
ััะพ ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปะตะผ postgres ะฟัะพะฟะธัะฐะฝั ะปะพะณะธะฝ ะธ ะฟะฐัะพะปั ะดะปั ัะตะฟะปะธะบะฐัะธะธ:
```
postgres@pg-cluster-02:~$ cat ~/.pgpass
*:*:*:biha_replication_user:XXXXXXXX
postgres@pg-cluster-02:~$
```
ะขัะฝะธะฝะณะพะฒะฐัั ะฟะพะด 1ะก ะฝะต ะฝัะถะฝะพ - ััะฝะธะฝะณะพะฒะฐะฝะฝัะน ะบะพะฝัะธะณ ะฟัะธะปะตัะธั ั ะผะฐััะตัะฐ ะฒ ะฟัะพัะตััะต ะฒะฒะพะดะฐ ะฝะพะดั ะฒ ะบะปะฐััะตั.

ะะพัะปะต ััะฟะตัะฝะพะน ะพััะฐะฑะพัะบะธ ะบะพะผะฐะฝะดั - ะทะฐะฟััะบะฐะตะผ ัะตัะฒะธั postgres:
```
systemctl start postgrespro-ent-17.service
```
ะัะพะฒะตััะตะผ ััะฐััั 2-ะน ะฝะพะดั ะฝะฐ ะปะธะดะตัะต:
```
postgres@pg-cluster-03:/data/postgres_data/pg_wal$ echo "SELECT * FROM biha.status_v;"|psql -d biha_db
id | leader_id | term | online |   state   | last_known_state | since_last_hb
----+-----------+------+--------+-----------+------------------+----------------
1 |         3 |    5 | f      | UNKNOWN   | UNKNOWN          |
2 |         3 |   11 | t      | FOLLOWER  | FOLLOWER         | 00:00:00.98187
3 |         3 |   11 | t      | LEADER_RW | LEADER_RW        |
(3 ัััะพะบะธ)
```

### ะขะพัะฐะปัะฝะฐั ะฟะตัะตะธะฝะธัะธะฐะปะธะทะฐัะธั ั ะฝัะปั ะฒ ัะปััะฐะต ัะฑะพั
ะัะปะธ ััะพ-ัะพ ะฟะพัะปะพ ะฝะต ัะฐะบ ะธ ะผั ัะตัะธะปะธ ะทะฐะฝะพะฒะพ ัะพะทะดะฐัั ะบะปะฐััะตั, ัะพ ะฟะพะฒัะพััะตะผ ะฝะฐ ะะกะะฅ ะฝะพะดะฐั,
ะฝะฐัะธะฝะฐั ั ะฟะพัะปะตะดะฝะตะน: 3, 2, 1:

ะกะฝะพัะธะผ ะฒัะต ะฟะฐะบะตัั ะฟะพััะณัะตัะฐ:
```
apt purge postgrespro-ent-17-client postgrespro-ent-17-contrib postgrespro-ent-17-libs postgrespro-ent-17-server 
```
ะกะผะพััะธะผ ะตััั ะปะธ ะทะฐะฟััะตะฝะฝัะต ะฟัะพัะตััั, ะตัะปะธ ะตััั - ะบะธะปัะตะผ ะธั ะฒัะต:
```
ps aux|grep postgre
kill 573326
```
ะฟะตัะตะฟัะพะฒะตััะตะผ, ััะพ ะฝะตั ะทะฐะฟััะตะฝะฝัั ะฟัะพัะตััะพะฒ, ะฟะพัะปะต ััะพะณะพ ัะดะฐะปัะตะผ ัะพะดะตัะถะธะผะพะต ะดะธัะตะบัะพัะธะธ ั ะดะฐะฝะฝัะผะธ:
```
rm -rf /data/postgres_data/*
```
ะฟะพะฒัะพััะตะผ ะฟัะฝะบัั, ะฝะฐัะธะฝะฐั ั ัะฐะทะดะตะปะฐ "ะกัะฐะฒะธะผ ะฟะตัะฒัั ะฝะพะดั"

### ะัะปะธ ะบะปะฐััะตั ะฟะฐะดะฐะตั ั ัะพะพะฑัะตะฝะธัะผะธ ะพ ะปะธะผะธัะฐั
ะัะธ ัะฐะฑะพัะต ั 1ะก ะผะพะถะตั ะฒะพะทะฝะธะบะฝััั ะพัะธะฑะบะฐ ะฟะตัะตะฟะพะปะฝะตะฝะธั ะปะธะผะธัะฐ ะพัะบััััั ัะฐะนะปะพะฒ. ะงัะพะฑั ะตั ะพะฑะพะนัะธ - ะฝัะถะฝะพ ัะฒะตะปะธัะธัั ะปะธะผะธั ะดะปั
systemd-unit-ะฐ postgrespro (ะฝะฐ ะฒัะตั ะฝะพะดะฐั ะบะปะฐััะตัะฐ):
```
systemcl edit postgrespro-ent-17.service
```
ะดะพะฑะฐะฒะธัั ัััะพะบะธ:
```
[Service]
LimitNOFILE=65536
```
ัะพััะฐะฝะธัั (ctrl+o), enter, ctrl+x

ะธ ะฟะตัะตะทะฐะณััะทะธัั ัะตัะฒะธัั postgrespro ะฝะฐ ะฒัะตั ะฝะพะดะฐั ะบะปะฐััะตัะฐ (ะฝะฐะฒะตัะฝะพะต ะปัััะต ั ะฝะตะบะพัะพััะผะธ ะฟัะพะผะตะถััะบะฐะผะธ ะธ ะบะพะฝััะพะปะตะผ ัะพััะพัะฝะธั ะบะปะฐััะตัะฐ):
```
systemcl restart postgrespro-ent-17.service
```

## ะะฐัััะพะนะบะฐ haproxy
ะะปั ะพัะณะฐะฝะธะทะฐัะธะธ ะตะดะธะฝะพะน ัะพัะบะธ ะฒัะพะดะฐ - ะฝัะถะฝะพ ะฝะฐัััะพะธัั haproxy.
ะกัะฐะฒะธะผ:
```
apt isntall haproxy
```
ะะฐัััะฐะธะฒะฐะตะผ ัะฐะนะป ะบะพะฝัะธะณััะฐัะธะธ /etc/haproxy/haproxy.cfg:
```
global
#       log 127.0.0.1:514       local0
        #log 127.0.0.1:514      local1 notice
        log 127.0.0.1:514       local0 debug
# ะธะฝะฐัะต ะฝะต ะฝะฐัะพะดะธั ัะบัะธะฟัั ะดะปั ะฟัะพะฒะตัะบะธ external-check
#       chroot /var/lib/haproxy
        stats socket /run/haproxy/admin.sock mode 660 level admin
        stats timeout 30s
        user haproxy
        group haproxy
        daemon
        # ัะฐะทัะตัะฐะตะผ ะฒะฝะตัะฝะธะต ะฟัะพะฒะตัะบะธ:
        insecure-fork-wanted
        external-check

        # Allows to enable or disable support mandatory access control (default: on)
        # The fetch methods (at Layer 4) was added:
        # * maclev - returns an integer value corresponding to the mandatory access control privacy level
        # * maccat - returns an integer value corresponding to the mandatory access control category
        # astra-mode on

        # Default SSL material locations
#       ca-base /etc/ssl/certs
#       crt-base /etc/ssl/private

        # See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
#        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
#        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
#        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
        log     global
        mode    tcp
        option tcplog
#       option  httplog
        option  dontlognull
        timeout connect 4s
        timeout client  30m
        timeout server  30m
        log-format "%{+Q}o\ client_address = %ci, client_port = %cp, server_address = %si, server_port = %sp path, status = %ST"
#       errorfile 400 /etc/haproxy/errors/400.http
#       errorfile 403 /etc/haproxy/errors/403.http
#       errorfile 408 /etc/haproxy/errors/408.http
#       errorfile 500 /etc/haproxy/errors/500.http
#       errorfile 502 /etc/haproxy/errors/502.http
#       errorfile 503 /etc/haproxy/errors/503.http
#       errorfile 504 /etc/haproxy/errors/504.http


#frontend pg_pro_master
#       bind *:5432     #HAProxy ัะปััะฐะตั ะฟะพัั 5432
#       use_backend pg_pro_cluster
#
#backend pg_pro_cluster
#       option pgsql-check user haproxy
#        server pg1 pg-cluster-01.internal:5432 check
#        server pg2 pg-cluster-02.internal:5432 check
#        server pg3 pg-cluster-03.internal:5432 check

frontend pg_pro_proxima_rw
        bind *:4545     #HAProxy ัะปััะฐะตั ะฟะพัั 4545
        #use_backend pg_pro_cluster_proxima_rw
        use_backend pg_pro_cluster_proxima_rw
        #external-check command /bin/true

backend pg_pro_cluster_proxima_rw
        #option tcplog
        #option log-health-checks
        # ะฟัะพะฒะตัะบะฐ ะฝะฐ ะผะฐััะตัะฐ:
        option external-check
        external-check path "/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/bin:/usr/sbin:/etc/haproxy/scripts"
        # ะฟะพะดะบะปััะฐะตะผัั ัะพะปัะบะพ ะบ ะผะฐััะตัั, ะฟัะพะฒะตััั ััะพ ัะบัะธะฟัะพะผ:
        external-check command /etc/haproxy/scripts/check_node_is_master.sh
        #external-check command /bin/true
        # ะทะฐะปะธะฟะฐะฝะธะต ัะตััะธะธ ะฝะฐ ะพะดะฝะพะผ ัะตัะฒะตัะต ะบะปะฐััะตัะฐ
        balance source
        server pg1 pg-cluster-01.internal:4545 check
        server pg2 pg-cluster-02.internal:4545 check
        server pg3 pg-cluster-03.internal:4545 check

frontend pg_pro_proxima_ro
        bind *:4547     #HAProxy ัะปััะฐะตั ะฟะพัั 4547
        use_backend pg_pro_cluster_proxima_ro

backend pg_pro_cluster_proxima_ro
        option pgsql-check user haproxy
        # ะฟัะพะฒะตััะตะผ ะฒ ะฟัะธะฝัะธะฟะต ะดะพัััะฟะฝะพััั, ั.ะบ. ะผะพะถะฝะพ ะฟะพะดะบะปััะฐัััั ะบ ะปัะฑะพะน ะถะธะฒะพะน ะฝะพะดะต:
        #option pgsql-check user haproxy_check password /etc/haproxy/pgsql_passwd option sql "SELECT 1"
        # ะฟะพะดะบะปััะฐะตะผัั ะบะพ ะฒัะตะผ ะฝะพะดะฐะผ:
        server pg1 pg-cluster-01.internal:4547 check
        server pg2 pg-cluster-02.internal:4547 check
        server pg3 pg-cluster-03.internal:4547 check
```
ัะบัะธะฟั ะฟัะพะฒะตัะบะธ ะฝะฐ ะปะธะดะตัะฐ/ัะตะฟะปะธะบั /etc/haproxy/scripts/check_node_is_master.sh :
```
#!/bin/bash

log=/var/log/haproxy_check_script.log

# ะธะดะตะฝัะธัะธะบะฐัะพั ัะตััะธะธ:
UNIQUE_ID=$(date +%s%N)_$RANDOM

# Variables passed by ldirectord/haproxy.
# $1 = VIP Address
# $2 = VIP Port
# $3 = Real Server IP
# $4 = Real Server Port

# Reassigning to named variables
server="${3}"
#port="${4}"
# ะฟะพัั ะฒัััะฐะฒะปัะตะผ ะฝะต proxima, ะฟะพัะพะผั ััะพ ะธะฝะฐัะต ะฒัะต ัะพะตะดะธะฝะตะฝะธั ะฒัั ัะฐะฒะฝะพ ะพะฝะฐ ะฟะตัะตะฝะฐะฟัะฐะฒะปัะตั ะฝะฐ ะปะธะดะตัะฐ ะธ ะฒัะตะณะดะฐ ะพัะฒะตั ะฑัะดะตั true. ะ ะตัะปะธ ะฟะพะดะบะปััะฐะตะผัั ะฝะฐ postgres ะฝะฐะฟััะผัั, ัะพ ะฟะพะปััะธะผ ัะพัะฝัะน ะพัะฒะตั ะผะฐััะตั ััะพ ะธะปะธ ะฒะตะดะพะผัะน:
port="5432"

echo "$(date +%Y.%m.%d-%T) id=$UNIQUE_ID: ===== start status of ${server}:${port} ====" >> "${log}"
echo "$(date +%Y.%m.%d-%T) id=$UNIQUE_ID: exec cmd: PGPASSWORD=\$(cat /etc/haproxy/pgsql_passwd) /opt/pgpro/ent-17/bin/psql -h $server -p $port -U haproxy_check -d postgres -t -c 'SELECT NOT pg_is_in_recovery()' 2>/dev/null | grep -q 't'" >> "${log}"

PGPASSWORD=$(cat /etc/haproxy/pgsql_passwd) /opt/pgpro/ent-17/bin/psql -h $server -p $port -U haproxy_check -d postgres -t -c "SELECT NOT pg_is_in_recovery()" 2>/dev/null | grep -q "t"

exit_status=$?

echo "$(date +%Y.%m.%d-%T) id=$UNIQUE_ID: for IP_node= $server:$port cmd return status = '$exit_status' (0 - node is master, not 0 - node is replica)" >> "${log}"

exit $exit_status
```
ะะฐัะพะปั ััะฐะฝะธััั ะฒ ัะฐะนะปะต ะฟัะพััะพ ัะตะบััะพะผ:
```
root@pg-cluster-proxy:/etc/haproxy# cat /etc/haproxy/pgsql_passwd
XXXXXXXXXX
root@pg-cluster-proxy:/etc/haproxy#
```
#### ะะพัััะฟ ะฟะพะปัะทะพะฒะฐัะตะปั haproxy_check ะฝะฐ ะบะปะฐััะตั
ะะฐ ะบะปะฐััะตัะต ะฝัะถะฝะพ ะดะพะฑะฐะฒะธัั ะฟะพะปัะทะพะฒะฐัะตะปั ะธ ะดะฐัั ะตะผั ะฟัะฐะฒะฐ:
```
su postgres
psql
```
ะฒัะฟะพะปะฝะธัั sql-ะบะพะผะฐะฝะดั:
```
CREATE USER haproxy_check WITH PASSWORD 'XXXXXXX' NOCREATEDB NOCREATEROLE NOSUPERUSER;
GRANT CONNECT ON DATABASE postgres TO haproxy_check;
grant execute  on pg_is_in_recovery to haproxy_check;
grant execute  on pg_is_in_recovery() to haproxy_check;
grant execute  on pg_is_in_recovery() to haproxy_check;
```








#FIXME ะดะฐะปะตะต - ััะฐัะพะต!





=>../index.gmi ๐ ะฒะตัะฝััััั ะบ ะฝะฐัะฐะปั...
